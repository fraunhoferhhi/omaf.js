/*! mp4box 19-02-2019
Copyright (c) 2012. Telecom ParisTech/TSI/MM/GPAC Cyril Concolato
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
    * Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
    * Neither the name of the copyright holder nor the
      names of its contributors may be used to endorse or promote products
      derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

var Log=function(){var a=new Date,b=4,c=3,d=2,e=1,f=b;return{setLogLevel:function(a){f=a==this.debug?e:a==this.info?d:a==this.warn?c:(this.error,b)},debug:function(b,c){void 0===console.debug&&(console.debug=console.log),e>=f&&console.debug("["+Log.getDurationString(new Date-a,1e3)+"]","["+b+"]",c)},info:function(b,c){d>=f&&console.info("["+Log.getDurationString(new Date-a,1e3)+"]","["+b+"]",c)},warn:function(b,d){c>=f&&console.warn("["+Log.getDurationString(new Date-a,1e3)+"]","["+b+"]",d)},error:function(c,d){b>=f&&console.error("["+Log.getDurationString(new Date-a,1e3)+"]","["+c+"]",d)}}}();Log.getDurationString=function(a,b){function c(a,b){for(var c=""+a,d=c.split(".");d[0].length<b;)d[0]="0"+d[0];return d.join(".")}var d;a<0?(d=!0,a=-a):d=!1;var e=b||1,f=a/e,g=Math.floor(f/3600);f-=3600*g;var h=Math.floor(f/60);f-=60*h;var i=1e3*f;return f=Math.floor(f),i-=1e3*f,i=Math.floor(i),(d?"-":"")+g+":"+c(h,2)+":"+c(f,2)+"."+c(i,3)},Log.printRanges=function(a){var b=a.length;if(b>0){for(var c="",d=0;d<b;d++)d>0&&(c+=","),c+="["+Log.getDurationString(a.start(d))+","+Log.getDurationString(a.end(d))+"]";return c}return"(empty)"},"undefined"!=typeof exports&&(exports.Log=Log);var MP4BoxStream=function(a){if(!(a instanceof ArrayBuffer))throw"Needs an array buffer";this.buffer=a,this.dataview=new DataView(a),this.position=0};MP4BoxStream.prototype.getPosition=function(){return this.position},MP4BoxStream.prototype.getEndPosition=function(){return this.buffer.byteLength},MP4BoxStream.prototype.getLength=function(){return this.buffer.byteLength},MP4BoxStream.prototype.seek=function(a){var b=Math.max(0,Math.min(this.buffer.byteLength,a));return this.position=isNaN(b)||!isFinite(b)?0:b,!0},MP4BoxStream.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},MP4BoxStream.prototype.readAnyInt=function(a,b){var c=0;if(this.position+a<=this.buffer.byteLength){switch(a){case 1:c=b?this.dataview.getInt8(this.position):this.dataview.getUint8(this.position);break;case 2:c=b?this.dataview.getInt16(this.position):this.dataview.getUint16(this.position);break;case 3:if(b)throw"No method for reading signed 24 bits values";c=this.dataview.getUint8(this.position)<<16,c|=this.dataview.getUint8(this.position)<<8,c|=this.dataview.getUint8(this.position);break;case 4:c=b?this.dataview.getInt32(this.position):this.dataview.getUint32(this.position);break;case 8:if(b)throw"No method for reading signed 64 bits values";c=this.dataview.getUint32(this.position)<<32,c|=this.dataview.getUint32(this.position);break;default:throw"readInt method not implemented for size: "+a}return this.position+=a,c}throw"Not enough bytes in buffer"},MP4BoxStream.prototype.readUint8=function(){return this.readAnyInt(1,!1)},MP4BoxStream.prototype.readUint16=function(){return this.readAnyInt(2,!1)},MP4BoxStream.prototype.readUint24=function(){return this.readAnyInt(3,!1)},MP4BoxStream.prototype.readUint32=function(){return this.readAnyInt(4,!1)},MP4BoxStream.prototype.readUint64=function(){return this.readAnyInt(8,!1)},MP4BoxStream.prototype.readString=function(a){if(this.position+a<=this.buffer.byteLength){for(var b="",c=0;c<a;c++)b+=String.fromCharCode(this.readUint8());return b}throw"Not enough bytes in buffer"},MP4BoxStream.prototype.readCString=function(){for(var a=[];;){var b=this.readUint8();if(0===b)break;a.push(b)}return String.fromCharCode.apply(null,a)},MP4BoxStream.prototype.readInt8=function(){return this.readAnyInt(1,!0)},MP4BoxStream.prototype.readInt16=function(){return this.readAnyInt(2,!0)},MP4BoxStream.prototype.readInt32=function(){return this.readAnyInt(4,!0)},MP4BoxStream.prototype.readInt64=function(){return this.readAnyInt(8,!1)},MP4BoxStream.prototype.readUint8Array=function(a){for(var b=new Uint8Array(a),c=0;c<a;c++)b[c]=this.readUint8();return b},MP4BoxStream.prototype.readInt16Array=function(a){for(var b=new Int16Array(a),c=0;c<a;c++)b[c]=this.readInt16();return b},MP4BoxStream.prototype.readUint16Array=function(a){for(var b=new Int16Array(a),c=0;c<a;c++)b[c]=this.readUint16();return b},MP4BoxStream.prototype.readUint32Array=function(a){for(var b=new Uint32Array(a),c=0;c<a;c++)b[c]=this.readUint32();return b},MP4BoxStream.prototype.readInt32Array=function(a){for(var b=new Int32Array(a),c=0;c<a;c++)b[c]=this.readInt32();return b},"undefined"!=typeof exports&&(exports.MP4BoxStream=MP4BoxStream);var DataStream=function(a,b,c){this._byteOffset=b||0,a instanceof ArrayBuffer?this.buffer=a:"object"==typeof a?(this.dataView=a,b&&(this._byteOffset+=b)):this.buffer=new ArrayBuffer(a||0),this.position=0,this.endianness=null==c?DataStream.LITTLE_ENDIAN:c};DataStream.prototype={},DataStream.prototype.getPosition=function(){return this.position},DataStream.prototype._realloc=function(a){if(this._dynamicSize){var b=this._byteOffset+this.position+a,c=this._buffer.byteLength;if(b<=c)return void(b>this._byteLength&&(this._byteLength=b));for(c<1&&(c=1);b>c;)c*=2;var d=new ArrayBuffer(c),e=new Uint8Array(this._buffer);new Uint8Array(d,0,e.length).set(e),this.buffer=d,this._byteLength=b}},DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var a=new ArrayBuffer(this._byteLength),b=new Uint8Array(a),c=new Uint8Array(this._buffer,0,b.length);b.set(c),this.buffer=a}},DataStream.BIG_ENDIAN=!1,DataStream.LITTLE_ENDIAN=!0,DataStream.prototype._byteLength=0,Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(DataStream.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(a){this._buffer=a,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(a){this._byteOffset=a,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(a){this._byteOffset=a.byteOffset,this._buffer=a.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+a.byteLength}}),DataStream.prototype.seek=function(a){var b=Math.max(0,Math.min(this.byteLength,a));this.position=isNaN(b)||!isFinite(b)?0:b},DataStream.prototype.isEof=function(){return this.position>=this._byteLength},DataStream.prototype.mapUint8Array=function(a){this._realloc(1*a);var b=new Uint8Array(this._buffer,this.byteOffset+this.position,a);return this.position+=1*a,b},DataStream.prototype.readInt32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var c=new Int32Array(a);return DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT),DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=c.byteLength,c},DataStream.prototype.readInt16Array=function(a,b){a=null==a?this.byteLength-this.position/2:a;var c=new Int16Array(a);return DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT),DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=c.byteLength,c},DataStream.prototype.readInt8Array=function(a){a=null==a?this.byteLength-this.position:a;var b=new Int8Array(a);return DataStream.memcpy(b.buffer,0,this.buffer,this.byteOffset+this.position,a*b.BYTES_PER_ELEMENT),this.position+=b.byteLength,b},DataStream.prototype.readUint32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var c=new Uint32Array(a);return DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT),DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=c.byteLength,c},DataStream.prototype.readUint16Array=function(a,b){a=null==a?this.byteLength-this.position/2:a;var c=new Uint16Array(a);return DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT),DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=c.byteLength,c},DataStream.prototype.readUint8Array=function(a){a=null==a?this.byteLength-this.position:a;var b=new Uint8Array(a);return DataStream.memcpy(b.buffer,0,this.buffer,this.byteOffset+this.position,a*b.BYTES_PER_ELEMENT),this.position+=b.byteLength,b},DataStream.prototype.readFloat64Array=function(a,b){a=null==a?this.byteLength-this.position/8:a;var c=new Float64Array(a);return DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT),DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=c.byteLength,c},DataStream.prototype.readFloat32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var c=new Float32Array(a);return DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT),DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=c.byteLength,c},DataStream.prototype.readInt32=function(a){var b=this._dataView.getInt32(this.position,null==a?this.endianness:a);return this.position+=4,b},DataStream.prototype.readInt16=function(a){var b=this._dataView.getInt16(this.position,null==a?this.endianness:a);return this.position+=2,b},DataStream.prototype.readInt8=function(){var a=this._dataView.getInt8(this.position);return this.position+=1,a},DataStream.prototype.readUint32=function(a){var b=this._dataView.getUint32(this.position,null==a?this.endianness:a);return this.position+=4,b},DataStream.prototype.readUint16=function(a){var b=this._dataView.getUint16(this.position,null==a?this.endianness:a);return this.position+=2,b},DataStream.prototype.readUint8=function(){var a=this._dataView.getUint8(this.position);return this.position+=1,a},DataStream.prototype.readFloat32=function(a){var b=this._dataView.getFloat32(this.position,null==a?this.endianness:a);return this.position+=4,b},DataStream.prototype.readFloat64=function(a){var b=this._dataView.getFloat64(this.position,null==a?this.endianness:a);return this.position+=8,b},DataStream.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,DataStream.memcpy=function(a,b,c,d,e){var f=new Uint8Array(a,b,e),g=new Uint8Array(c,d,e);f.set(g)},DataStream.arrayToNative=function(a,b){return b==this.endianness?a:this.flipArrayEndianness(a)},DataStream.nativeToEndian=function(a,b){return this.endianness==b?a:this.flipArrayEndianness(a)},DataStream.flipArrayEndianness=function(a){for(var b=new Uint8Array(a.buffer,a.byteOffset,a.byteLength),c=0;c<a.byteLength;c+=a.BYTES_PER_ELEMENT)for(var d=c+a.BYTES_PER_ELEMENT-1,e=c;d>e;d--,e++){var f=b[e];b[e]=b[d],b[d]=f}return a},DataStream.prototype.failurePosition=0,String.fromCharCodeUint8=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return String.fromCharCode.apply(null,b)},DataStream.prototype.readString=function(a,b){return null==b||"ASCII"==b?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==a?this.byteLength-this.position:a)]):new TextDecoder(b).decode(this.mapUint8Array(a))},DataStream.prototype.readCString=function(a){var b=this.byteLength-this.position,c=new Uint8Array(this._buffer,this._byteOffset+this.position),d=b;null!=a&&(d=Math.min(a,b));for(var e=0;e<d&&0!==c[e];e++);var f=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(e)]);return null!=a?this.position+=d-e:e!=b&&(this.position+=1),f};var MAX_SIZE=Math.pow(2,32);DataStream.prototype.readInt64=function(){return this.readInt32()*MAX_SIZE+this.readUint32()},DataStream.prototype.readUint64=function(){return this.readUint32()*MAX_SIZE+this.readUint32()},DataStream.prototype.readInt64=function(){return this.readUint32()*MAX_SIZE+this.readUint32()},DataStream.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},"undefined"!=typeof exports&&(exports.DataStream=DataStream),DataStream.prototype.save=function(a){var b=new Blob([this.buffer]);if(!window.URL||!URL.createObjectURL)throw"DataStream.save: Can't create object URL.";var c=window.URL.createObjectURL(b),d=document.createElement("a");d.setAttribute("href",c),d.setAttribute("download",a),d.click(),window.URL.revokeObjectURL(c)},DataStream.prototype._dynamicSize=!0,Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(a){a||this._trimAlloc(),this._dynamicSize=a}}),DataStream.prototype.shift=function(a){var b=new ArrayBuffer(this._byteLength-a),c=new Uint8Array(b),d=new Uint8Array(this._buffer,a,c.length);c.set(d),this.buffer=b,this.position-=a},DataStream.prototype.writeInt32Array=function(a,b){if(this._realloc(4*a.length),a instanceof Int32Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapInt32Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeInt32(a[c],b)},DataStream.prototype.writeInt16Array=function(a,b){if(this._realloc(2*a.length),a instanceof Int16Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapInt16Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeInt16(a[c],b)},DataStream.prototype.writeInt8Array=function(a){if(this._realloc(1*a.length),a instanceof Int8Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapInt8Array(a.length);else for(var b=0;b<a.length;b++)this.writeInt8(a[b])},DataStream.prototype.writeUint32Array=function(a,b){if(this._realloc(4*a.length),a instanceof Uint32Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapUint32Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeUint32(a[c],b)},DataStream.prototype.writeUint16Array=function(a,b){if(this._realloc(2*a.length),a instanceof Uint16Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapUint16Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeUint16(a[c],b)},DataStream.prototype.writeUint8Array=function(a){if(this._realloc(1*a.length),a instanceof Uint8Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapUint8Array(a.length);else for(var b=0;b<a.length;b++)this.writeUint8(a[b])},DataStream.prototype.writeFloat64Array=function(a,b){if(this._realloc(8*a.length),a instanceof Float64Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapFloat64Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeFloat64(a[c],b)},DataStream.prototype.writeFloat32Array=function(a,b){if(this._realloc(4*a.length),a instanceof Float32Array&&this.byteOffset+this.position%a.BYTES_PER_ELEMENT===0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,0,a.byteLength),this.mapFloat32Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeFloat32(a[c],b)},DataStream.prototype.writeInt32=function(a,b){this._realloc(4),this._dataView.setInt32(this.position,a,null==b?this.endianness:b),this.position+=4},DataStream.prototype.writeInt16=function(a,b){this._realloc(2),this._dataView.setInt16(this.position,a,null==b?this.endianness:b),this.position+=2},DataStream.prototype.writeInt8=function(a){this._realloc(1),this._dataView.setInt8(this.position,a),this.position+=1},DataStream.prototype.writeUint32=function(a,b){this._realloc(4),this._dataView.setUint32(this.position,a,null==b?this.endianness:b),this.position+=4},DataStream.prototype.writeUint16=function(a,b){this._realloc(2),this._dataView.setUint16(this.position,a,null==b?this.endianness:b),this.position+=2},DataStream.prototype.writeUint8=function(a){this._realloc(1),this._dataView.setUint8(this.position,a),this.position+=1},DataStream.prototype.writeFloat32=function(a,b){this._realloc(4),this._dataView.setFloat32(this.position,a,null==b?this.endianness:b),this.position+=4},DataStream.prototype.writeFloat64=function(a,b){this._realloc(8),this._dataView.setFloat64(this.position,a,null==b?this.endianness:b),this.position+=8},DataStream.prototype.writeUCS2String=function(a,b,c){null==c&&(c=a.length);for(var d=0;d<a.length&&d<c;d++)this.writeUint16(a.charCodeAt(d),b);for(;d<c;d++)this.writeUint16(0)},DataStream.prototype.writeString=function(a,b,c){var d=0;if(null==b||"ASCII"==b)if(null!=c){var e=Math.min(a.length,c);for(d=0;d<e;d++)this.writeUint8(a.charCodeAt(d));for(;d<c;d++)this.writeUint8(0)}else for(d=0;d<a.length;d++)this.writeUint8(a.charCodeAt(d));else this.writeUint8Array(new TextEncoder(b).encode(a.substring(0,c)))},DataStream.prototype.writeCString=function(a,b){var c=0;if(null!=b){var d=Math.min(a.length,b);for(c=0;c<d;c++)this.writeUint8(a.charCodeAt(c));for(;c<b;c++)this.writeUint8(0)}else{for(c=0;c<a.length;c++)this.writeUint8(a.charCodeAt(c));this.writeUint8(0)}},DataStream.prototype.writeStruct=function(a,b){for(var c=0;c<a.length;c+=2){var d=a[c+1];this.writeType(d,b[a[c]],b)}},DataStream.prototype.writeType=function(a,b,c){var d;if("function"==typeof a)return a(this,b);if("object"==typeof a&&!(a instanceof Array))return a.set(this,b,c);var e=null,f="ASCII",g=this.position;switch("string"==typeof a&&/:/.test(a)&&(d=a.split(":"),a=d[0],e=parseInt(d[1])),"string"==typeof a&&/,/.test(a)&&(d=a.split(","),a=d[0],f=parseInt(d[1])),a){case"uint8":this.writeUint8(b);break;case"int8":this.writeInt8(b);break;case"uint16":this.writeUint16(b,this.endianness);break;case"int16":this.writeInt16(b,this.endianness);break;case"uint32":this.writeUint32(b,this.endianness);break;case"int32":this.writeInt32(b,this.endianness);break;case"float32":this.writeFloat32(b,this.endianness);break;case"float64":this.writeFloat64(b,this.endianness);break;case"uint16be":this.writeUint16(b,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(b,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(b,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(b,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(b,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(b,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(b,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(b,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(b,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(b,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(b,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(b,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(b,e);break;case"string":this.writeString(b,f,e);break;case"u16string":this.writeUCS2String(b,this.endianness,e);break;case"u16stringle":this.writeUCS2String(b,DataStream.LITTLE_ENDIAN,e);break;case"u16stringbe":this.writeUCS2String(b,DataStream.BIG_ENDIAN,e);break;default:if(3==a.length){for(var h=a[1],i=0;i<b.length;i++)this.writeType(h,b[i]);break}this.writeStruct(a,b)}null!=e&&(this.position=g,this._realloc(e),this.position=g+e)},DataStream.prototype.writeUint64=function(a){var b=Math.floor(a/MAX_SIZE);this.writeUint32(b),this.writeUint32(4294967295&a)},DataStream.prototype.writeUint24=function(a){this.writeUint8((16711680&a)>>16),this.writeUint8((65280&a)>>8),this.writeUint8(255&a)},DataStream.prototype.adjustUint32=function(a,b){var c=this.position;this.seek(a),this.writeUint32(b),this.seek(c)},DataStream.prototype.mapInt32Array=function(a,b){this._realloc(4*a);var c=new Int32Array(this._buffer,this.byteOffset+this.position,a);return DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=4*a,c},DataStream.prototype.mapInt16Array=function(a,b){this._realloc(2*a);var c=new Int16Array(this._buffer,this.byteOffset+this.position,a);return DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=2*a,c},DataStream.prototype.mapInt8Array=function(a){this._realloc(1*a);var b=new Int8Array(this._buffer,this.byteOffset+this.position,a);return this.position+=1*a,b},DataStream.prototype.mapUint32Array=function(a,b){this._realloc(4*a);var c=new Uint32Array(this._buffer,this.byteOffset+this.position,a);return DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=4*a,c},DataStream.prototype.mapUint16Array=function(a,b){this._realloc(2*a);var c=new Uint16Array(this._buffer,this.byteOffset+this.position,a);return DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=2*a,c},DataStream.prototype.mapFloat64Array=function(a,b){this._realloc(8*a);var c=new Float64Array(this._buffer,this.byteOffset+this.position,a);return DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=8*a,c},DataStream.prototype.mapFloat32Array=function(a,b){this._realloc(4*a);var c=new Float32Array(this._buffer,this.byteOffset+this.position,a);return DataStream.arrayToNative(c,null==b?this.endianness:b),this.position+=4*a,c};var MultiBufferStream=function(a){this.buffers=[],this.bufferIndex=-1,a&&(this.insertBuffer(a),this.bufferIndex=0)};MultiBufferStream.prototype=new DataStream(new ArrayBuffer,0,DataStream.BIG_ENDIAN),MultiBufferStream.prototype.initialized=function(){var a;return this.bufferIndex>-1||(this.buffers.length>0?(a=this.buffers[0],0===a.fileStart?(this.buffer=a,this.bufferIndex=0,Log.debug("MultiBufferStream","Stream ready for parsing"),!0):(Log.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(Log.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))},ArrayBuffer.concat=function(a,b){Log.debug("ArrayBuffer","Trying to create a new buffer of size: "+(a.byteLength+b.byteLength));var c=new Uint8Array(a.byteLength+b.byteLength);return c.set(new Uint8Array(a),0),c.set(new Uint8Array(b),a.byteLength),c.buffer},MultiBufferStream.prototype.reduceBuffer=function(a,b,c){var d;return d=new Uint8Array(c),d.set(new Uint8Array(a,b,c)),d.buffer.fileStart=a.fileStart+b,d.buffer.usedBytes=0,d.buffer},MultiBufferStream.prototype.insertBuffer=function(a){for(var b=!0,c=0;c<this.buffers.length;c++){var d=this.buffers[c];if(a.fileStart<=d.fileStart){if(a.fileStart===d.fileStart){if(a.byteLength>d.byteLength){this.buffers.splice(c,1),c--;continue}Log.warn("MultiBufferStream","Buffer (fileStart: "+a.fileStart+" - Length: "+a.byteLength+") already appended, ignoring")}else a.fileStart+a.byteLength<=d.fileStart||(a=this.reduceBuffer(a,0,d.fileStart-a.fileStart)),Log.debug("MultiBufferStream","Appending new buffer (fileStart: "+a.fileStart+" - Length: "+a.byteLength+")"),this.buffers.splice(c,0,a),0===c&&(this.buffer=a);b=!1;break}if(a.fileStart<d.fileStart+d.byteLength){var e=d.fileStart+d.byteLength-a.fileStart,f=a.byteLength-e;if(!(f>0)){b=!1;break}a=this.reduceBuffer(a,e,f)}}b&&(Log.debug("MultiBufferStream","Appending new buffer (fileStart: "+a.fileStart+" - Length: "+a.byteLength+")"),this.buffers.push(a),0===c&&(this.buffer=a))},MultiBufferStream.prototype.logBufferLevel=function(a){var b,c,d,e,f,g=[],h="";for(d=0,e=0,b=0;b<this.buffers.length;b++)c=this.buffers[b],0===b?(f={},g.push(f),f.start=c.fileStart,f.end=c.fileStart+c.byteLength,h+="["+f.start+"-"):f.end===c.fileStart?f.end=c.fileStart+c.byteLength:(f={},f.start=c.fileStart,h+=g[g.length-1].end-1+"], ["+f.start+"-",f.end=c.fileStart+c.byteLength,g.push(f)),d+=c.usedBytes,e+=c.byteLength;g.length>0&&(h+=f.end-1+"]");var i=a?Log.info:Log.debug;0===this.buffers.length?i("MultiBufferStream","No more buffer in memory"):i("MultiBufferStream",this.buffers.length+" stored buffer(s) ("+d+"/"+e+" bytes): "+h)},MultiBufferStream.prototype.cleanBuffers=function(){var a,b;for(a=0;a<this.buffers.length;a++)b=this.buffers[a],b.usedBytes===b.byteLength&&(Log.debug("MultiBufferStream","Removing buffer #"+a),this.buffers.splice(a,1),a--)},MultiBufferStream.prototype.mergeNextBuffer=function(){var a;if(this.bufferIndex+1<this.buffers.length){if(a=this.buffers[this.bufferIndex+1],a.fileStart===this.buffer.fileStart+this.buffer.byteLength){var b=this.buffer.byteLength,c=this.buffer.usedBytes,d=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,a),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=c,this.buffer.fileStart=d,Log.debug("ISOFile","Concatenating buffer for box parsing (length: "+b+"->"+this.buffer.byteLength+")"),!0}return!1}return!1},MultiBufferStream.prototype.findPosition=function(a,b,c){var d,e=null,f=-1;for(d=!0===a?0:this.bufferIndex;d<this.buffers.length&&(e=this.buffers[d],e.fileStart<=b);)f=d,c&&(e.fileStart+e.byteLength<=b?e.usedBytes=e.byteLength:e.usedBytes=b-e.fileStart,this.logBufferLevel()),d++;return-1!==f?(e=this.buffers[f],e.fileStart+e.byteLength>=b?(Log.debug("MultiBufferStream","Found position in existing buffer #"+f),f):-1):-1},MultiBufferStream.prototype.findEndContiguousBuf=function(a){var b,c,d,e=void 0!==a?a:this.bufferIndex;if(c=this.buffers[e],this.buffers.length>e+1)for(b=e+1;b<this.buffers.length&&(d=this.buffers[b],d.fileStart===c.fileStart+c.byteLength);b++)c=d;return c.fileStart+c.byteLength},MultiBufferStream.prototype.getEndFilePositionAfter=function(a){var b=this.findPosition(!0,a,!1);return-1!==b?this.findEndContiguousBuf(b):a},MultiBufferStream.prototype.addUsedBytes=function(a){this.buffer.usedBytes+=a,this.logBufferLevel()},MultiBufferStream.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},MultiBufferStream.prototype.seek=function(a,b,c){var d;return d=this.findPosition(b,a,c),-1!==d?(this.buffer=this.buffers[d],this.bufferIndex=d,this.position=a-this.buffer.fileStart,Log.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(Log.debug("MultiBufferStream","Position "+a+" not found in buffered data"),!1)},MultiBufferStream.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},MultiBufferStream.prototype.getLength=function(){return this.byteLength},MultiBufferStream.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},"undefined"!=typeof exports&&(exports.MultiBufferStream=MultiBufferStream);var MPEG4DescriptorParser=function(){var a=3,b=4,c=5,d=6,e=[];e[a]="ES_Descriptor",e[b]="DecoderConfigDescriptor",e[c]="DecoderSpecificInfo",e[d]="SLConfigDescriptor",this.getDescriptorName=function(a){return e[a]};var f=this,g={};return this.parseOneDescriptor=function(a){var b,c,d,f=0,h=0;for(b=a.readUint8(),f++,d=a.readUint8(),f++;128&d;)h=(127&d)<<7,d=a.readUint8(),f++;return h+=127&d,Log.debug("MPEG4DescriptorParser","Found "+(e[b]||"Descriptor "+b)+", size "+h+" at position "+a.getPosition()),c=e[b]?new g[e[b]](h):new g.Descriptor(h),c.parse(a),c},g.Descriptor=function(a,b){this.tag=a,this.size=b,this.descs=[]},g.Descriptor.prototype.parse=function(a){this.data=a.readUint8Array(this.size)},g.Descriptor.prototype.findDescriptor=function(a){for(var b=0;b<this.descs.length;b++)if(this.descs[b].tag==a)return this.descs[b];return null},g.Descriptor.prototype.parseRemainingDescriptors=function(a){for(var b=a.position;a.position<b+this.size;){var c=f.parseOneDescriptor(a);this.descs.push(c)}},g.ES_Descriptor=function(b){g.Descriptor.call(this,a,b)},g.ES_Descriptor.prototype=new g.Descriptor,g.ES_Descriptor.prototype.parse=function(a){if(this.ES_ID=a.readUint16(),this.flags=a.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=a.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){var b=a.readUint8();this.URL=a.readString(b),this.size-=b+1}else this.URL="";32&this.flags?(this.OCR_ES_ID=a.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(a)},g.ES_Descriptor.prototype.getOTI=function(a){var c=this.findDescriptor(b);return c?c.oti:0},g.ES_Descriptor.prototype.getAudioConfig=function(a){var d=this.findDescriptor(b);if(!d)return null;var e=d.findDescriptor(c);if(e&&e.data){var f=(248&e.data[0])>>3;return 31===f&&e.data.length>=2&&(f=32+((7&e.data[0])<<3)+((224&e.data[1])>>5)),f}return null},g.DecoderConfigDescriptor=function(a){g.Descriptor.call(this,b,a)},g.DecoderConfigDescriptor.prototype=new g.Descriptor,g.DecoderConfigDescriptor.prototype.parse=function(a){this.oti=a.readUint8(),this.streamType=a.readUint8(),this.bufferSize=a.readUint24(),this.maxBitrate=a.readUint32(),this.avgBitrate=a.readUint32(),this.size-=13,this.parseRemainingDescriptors(a)},g.DecoderSpecificInfo=function(a){g.Descriptor.call(this,c,a)},g.DecoderSpecificInfo.prototype=new g.Descriptor,g.SLConfigDescriptor=function(a){g.Descriptor.call(this,d,a)},g.SLConfigDescriptor.prototype=new g.Descriptor,this};"undefined"!=typeof exports&&(exports.MPEG4DescriptorParser=MPEG4DescriptorParser);var BoxParser={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){BoxParser.FullBox.prototype=new BoxParser.Box,BoxParser.ContainerBox.prototype=new BoxParser.Box,BoxParser.SampleEntry.prototype=new BoxParser.Box,BoxParser.TrackGroupTypeBox.prototype=new BoxParser.FullBox,BoxParser.BASIC_BOXES.forEach(function(a){BoxParser.createBoxCtor(a)}),BoxParser.FULL_BOXES.forEach(function(a){BoxParser.createFullBoxCtor(a)}),BoxParser.CONTAINER_BOXES.forEach(function(a){BoxParser.createContainerBoxCtor(a[0],null,a[1])})},Box:function(a,b,c){this.type=a,this.size=b,this.uuid=c},FullBox:function(a,b,c){BoxParser.Box.call(this,a,b,c),this.flags=0,this.version=0},ContainerBox:function(a,b,c){BoxParser.Box.call(this,a,b,c),this.boxes=[]},SampleEntry:function(a,b,c,d){BoxParser.ContainerBox.call(this,a,b),this.hdr_size=c,this.start=d},SampleGroupEntry:function(a){this.grouping_type=a},TrackGroupTypeBox:function(a,b){BoxParser.FullBox.call(this,a,b)},createBoxCtor:function(a,b){BoxParser.boxCodes.push(a),BoxParser[a+"Box"]=function(b){BoxParser.Box.call(this,a,b)},BoxParser[a+"Box"].prototype=new BoxParser.Box,b&&(BoxParser[a+"Box"].prototype.parse=b)},createFullBoxCtor:function(a,b){BoxParser[a+"Box"]=function(b){BoxParser.FullBox.call(this,a,b)},BoxParser[a+"Box"].prototype=new BoxParser.FullBox,BoxParser[a+"Box"].prototype.parse=function(a){this.parseFullHeader(a),b&&b.call(this,a)}},addSubBoxArrays:function(a){if(a){this.subBoxNames=a;for(var b=a.length,c=0;c<b;c++)this[a[c]+"s"]=[]}},createContainerBoxCtor:function(a,b,c){BoxParser[a+"Box"]=function(b){BoxParser.ContainerBox.call(this,a,b),BoxParser.addSubBoxArrays.call(this,c)},BoxParser[a+"Box"].prototype=new BoxParser.ContainerBox,b&&(BoxParser[a+"Box"].prototype.parse=b)},createMediaSampleEntryCtor:function(a,b,c){BoxParser.sampleEntryCodes[a]=[],BoxParser[a+"SampleEntry"]=function(a,b){BoxParser.SampleEntry.call(this,a,b),BoxParser.addSubBoxArrays.call(this,c)},BoxParser[a+"SampleEntry"].prototype=new BoxParser.SampleEntry,b&&(BoxParser[a+"SampleEntry"].prototype.parse=b)},createSampleEntryCtor:function(a,b,c,d){BoxParser.sampleEntryCodes[a].push(b),BoxParser[b+"SampleEntry"]=function(c){BoxParser[a+"SampleEntry"].call(this,b,c),
BoxParser.addSubBoxArrays.call(this,d)},BoxParser[b+"SampleEntry"].prototype=new BoxParser[a+"SampleEntry"],c&&(BoxParser[b+"SampleEntry"].prototype.parse=c)},createEncryptedSampleEntryCtor:function(a,b,c){BoxParser.createSampleEntryCtor.call(this,a,b,c,["sinf"])},createSampleGroupCtor:function(a,b){BoxParser[a+"SampleGroupEntry"]=function(b){BoxParser.SampleGroupEntry.call(this,a,b)},BoxParser[a+"SampleGroupEntry"].prototype=new BoxParser.SampleGroupEntry,b&&(BoxParser[a+"SampleGroupEntry"].prototype.parse=b)},createTrackGroupCtor:function(a,b){BoxParser[a+"TrackGroupTypeBox"]=function(b){BoxParser.TrackGroupTypeBox.call(this,a,b)},BoxParser[a+"TrackGroupTypeBox"].prototype=new BoxParser.TrackGroupTypeBox,b&&(BoxParser[a+"TrackGroupTypeBox"].prototype.parse=b)},createUUIDBox:function(a,b,c,d){BoxParser.UUIDBoxes[a]=function(d){b?BoxParser.FullBox.call(this,"uuid",d,a):c?BoxParser.ContainerBox.call(this,"uuid",d,a):BoxParser.Box.call(this,"uuid",d,a)},BoxParser.UUIDBoxes[a].prototype=b?new BoxParser.FullBox:c?new BoxParser.ContainerBox:new BoxParser.Box,d&&(BoxParser.UUIDBoxes[a].prototype.parse=b?function(a){this.parseFullHeader(a),d&&d.call(this,a)}:d)}};BoxParser.initialize(),BoxParser.TKHD_FLAG_ENABLED=1,BoxParser.TKHD_FLAG_IN_MOVIE=2,BoxParser.TKHD_FLAG_IN_PREVIEW=4,BoxParser.TFHD_FLAG_BASE_DATA_OFFSET=1,BoxParser.TFHD_FLAG_SAMPLE_DESC=2,BoxParser.TFHD_FLAG_SAMPLE_DUR=8,BoxParser.TFHD_FLAG_SAMPLE_SIZE=16,BoxParser.TFHD_FLAG_SAMPLE_FLAGS=32,BoxParser.TFHD_FLAG_DUR_EMPTY=65536,BoxParser.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,BoxParser.TRUN_FLAGS_DATA_OFFSET=1,BoxParser.TRUN_FLAGS_FIRST_FLAG=4,BoxParser.TRUN_FLAGS_DURATION=256,BoxParser.TRUN_FLAGS_SIZE=512,BoxParser.TRUN_FLAGS_FLAGS=1024,BoxParser.TRUN_FLAGS_CTS_OFFSET=2048,BoxParser.Box.prototype.add=function(a){return this.addBox(new BoxParser[a+"Box"])},BoxParser.Box.prototype.addBox=function(a){return this.boxes.push(a),this[a.type+"s"]?this[a.type+"s"].push(a):this[a.type]=a,a},BoxParser.Box.prototype.set=function(a,b){return this[a]=b,this},BoxParser.Box.prototype.addEntry=function(a,b){var c=b||"entries";return this[c]||(this[c]=[]),this[c].push(a),this},"undefined"!=typeof exports&&(exports.BoxParser=BoxParser),BoxParser.parseUUID=function(a){return BoxParser.parseHex16(a)},BoxParser.parseHex16=function(a){for(var b="",c=0;c<16;c++){var d=a.readUint8().toString(16);b+=1===d.length?"0"+d:d}return b},BoxParser.parseOneBox=function(a,b,c){var d,e,f,g=a.getPosition(),h=0;if(a.getEndPosition()-g<8)return Log.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA};if(c&&c<8)return Log.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA};var i=a.readUint32(),j=a.readString(4),k=j;if(Log.debug("BoxParser","Found box of type '"+j+"' and size "+i+" at position "+g),h=8,"uuid"==j){if(a.getEndPosition()-a.getPosition()<16||c-h<16)return a.seek(g),Log.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA};f=BoxParser.parseUUID(a),h+=16,k=f}if(1==i){if(a.getEndPosition()-a.getPosition()<8||c&&c-h<8)return a.seek(g),Log.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+j+'" box'),{code:BoxParser.ERR_NOT_ENOUGH_DATA};i=a.readUint64(),h+=8}else if(0===i)if(c)i=c;else if("mdat"!==j)return Log.error("BoxParser","Unlimited box size not supported for type: '"+j+"'"),d=new BoxParser.Box(j,i),{code:BoxParser.OK,box:d,size:d.size};return i<h?(Log.error("BoxParser","Box of type "+j+" has an invalid size "+i+" (too small to be a box)"),{code:BoxParser.ERR_NOT_ENOUGH_DATA,type:j,size:i,hdr_size:h,start:g}):c&&i>c?(Log.error("BoxParser","Box of type '"+j+"' has a size "+i+" greater than its container size "+c),{code:BoxParser.ERR_NOT_ENOUGH_DATA,type:j,size:i,hdr_size:h,start:g}):g+i>a.getEndPosition()?(a.seek(g),Log.info("BoxParser","Not enough data in stream to parse the entire '"+j+"' box"),{code:BoxParser.ERR_NOT_ENOUGH_DATA,type:j,size:i,hdr_size:h,start:g}):b?{code:BoxParser.OK,type:j,size:i,hdr_size:h,start:g}:(BoxParser[j+"Box"]?d=new BoxParser[j+"Box"](i):"uuid"!==j?(Log.warn("BoxParser","Unknown box type: '"+j+"'"),d=new BoxParser.Box(j,i),d.has_unparsed_data=!0):BoxParser.UUIDBoxes[f]?d=new BoxParser.UUIDBoxes[f](i):(Log.warn("BoxParser","Unknown uuid type: '"+f+"'"),d=new BoxParser.Box(j,i),d.uuid=f,d.has_unparsed_data=!0),d.hdr_size=h,d.start=g,d.write===BoxParser.Box.prototype.write&&"mdat"!==d.type&&(Log.info("BoxParser","'"+k+"' box writing not yet implemented, keeping unparsed data in memory for later write"),d.parseDataAndRewind(a)),d.parse(a),e=a.getPosition()-(d.start+d.size),e<0?(Log.warn("BoxParser","Parsing of box '"+k+"' did not read the entire indicated box data size (missing "+-e+" bytes), seeking forward"),a.seek(d.start+d.size)):e>0&&(Log.error("BoxParser","Parsing of box '"+k+"' read "+e+" more bytes than the indicated box data size, seeking backwards"),a.seek(d.start+d.size)),{code:BoxParser.OK,box:d,size:d.size})},BoxParser.Box.prototype.parse=function(a){"mdat"!=this.type?this.data=a.readUint8Array(this.size-this.hdr_size):0===this.size?a.seek(a.getEndPosition()):a.seek(this.start+this.size)},BoxParser.Box.prototype.parseDataAndRewind=function(a){this.data=a.readUint8Array(this.size-this.hdr_size),a.position-=this.size-this.hdr_size},BoxParser.FullBox.prototype.parseDataAndRewind=function(a){this.parseFullHeader(a),this.data=a.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,a.position-=this.size-this.hdr_size},BoxParser.FullBox.prototype.parseFullHeader=function(a){this.version=a.readUint8(),this.flags=a.readUint24(),this.hdr_size+=4},BoxParser.FullBox.prototype.parse=function(a){this.parseFullHeader(a),this.data=a.readUint8Array(this.size-this.hdr_size)},BoxParser.ContainerBox.prototype.parse=function(a){for(var b,c;a.getPosition()<this.start+this.size;){if(b=BoxParser.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code!==BoxParser.OK)return;if(c=b.box,this.boxes.push(c),this.subBoxNames&&-1!=this.subBoxNames.indexOf(c.type))this[this.subBoxNames[this.subBoxNames.indexOf(c.type)]+"s"].push(c);else{var d="uuid"!==c.type?c.type:c.uuid;this[d]?Log.warn("Box of type "+d+" already stored in field of this type"):this[d]=c}}},BoxParser.Box.prototype.parseLanguage=function(a){this.language=a.readUint16();var b=[];b[0]=this.language>>10&31,b[1]=this.language>>5&31,b[2]=31&this.language,this.languageString=String.fromCharCode(b[0]+96,b[1]+96,b[2]+96)},BoxParser.SAMPLE_ENTRY_TYPE_VISUAL="Visual",BoxParser.SAMPLE_ENTRY_TYPE_AUDIO="Audio",BoxParser.SAMPLE_ENTRY_TYPE_HINT="Hint",BoxParser.SAMPLE_ENTRY_TYPE_METADATA="Metadata",BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",BoxParser.SAMPLE_ENTRY_TYPE_SYSTEM="System",BoxParser.SAMPLE_ENTRY_TYPE_TEXT="Text",BoxParser.SampleEntry.prototype.parseHeader=function(a){a.readUint8Array(6),this.data_reference_index=a.readUint16(),this.hdr_size+=8},BoxParser.SampleEntry.prototype.parse=function(a){this.parseHeader(a),this.data=a.readUint8Array(this.size-this.hdr_size)},BoxParser.SampleEntry.prototype.parseDataAndRewind=function(a){this.parse(a),this.hdr_size-=8,a.position-=this.size-this.hdr_size},BoxParser.SampleEntry.prototype.parseFooter=function(a){BoxParser.ContainerBox.prototype.parse.call(this,a)},BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_HINT),BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_METADATA),BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE),BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SYSTEM),BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_TEXT),BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_VISUAL,function(a){this.parseHeader(a),a.readUint16(),a.readUint16(),a.readUint32Array(3),this.width=a.readUint16(),this.height=a.readUint16(),this.horizresolution=a.readUint32(),this.vertresolution=a.readUint32(),a.readUint32(),this.frame_count=a.readUint16(),compressorname_length=Math.min(31,a.readUint8()),this.compressorname=a.readString(compressorname_length),compressorname_length<31&&a.readString(31-compressorname_length),this.depth=a.readUint16(),a.readUint16(),this.parseFooter(a)}),BoxParser.createMediaSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_AUDIO,function(a){this.parseHeader(a),a.readUint32Array(2),this.channel_count=a.readUint16(),this.samplesize=a.readUint16(),a.readUint16(),a.readUint16(),this.samplerate=a.readUint32()/65536,this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),BoxParser.createEncryptedSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),BoxParser.createEncryptedSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),BoxParser.createEncryptedSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),BoxParser.createEncryptedSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),BoxParser.createEncryptedSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_TEXT,"enct"),BoxParser.createEncryptedSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_METADATA,"encm"),BoxParser.createFullBoxCtor("CoLL",function(a){this.maxCLL=a.readUint16(),this.maxFALL=a.readUint16()}),BoxParser.createFullBoxCtor("SmDm",function(a){this.primaryRChromaticity_x=a.readUint16(),this.primaryRChromaticity_y=a.readUint16(),this.primaryGChromaticity_x=a.readUint16(),this.primaryGChromaticity_y=a.readUint16(),this.primaryBChromaticity_x=a.readUint16(),this.primaryBChromaticity_y=a.readUint16(),this.whitePointChromaticity_x=a.readUint16(),this.whitePointChromaticity_y=a.readUint16(),this.luminanceMax=a.readUint32(),this.luminanceMin=a.readUint32()}),BoxParser.TrackGroupTypeBox.prototype.parse=function(a){this.parseFullHeader(a),this.track_group_id=a.readUint32()},BoxParser.TrackReferenceTypeBox=function(a,b,c,d){BoxParser.Box.call(this,a,b),this.hdr_size=c,this.start=d},BoxParser.TrackReferenceTypeBox.prototype=new BoxParser.Box,BoxParser.TrackReferenceTypeBox.prototype.parse=function(a){this.track_ids=a.readUint32Array((this.size-this.hdr_size)/4)},BoxParser.createBoxCtor("av1C",function(a){var b=a.readUint8();if(b>>7&!1)return void Log.error("av1C marker problem");if(this.version=127&b,1!==this.version)return void Log.error("av1C version "+this.version+" not supported");if(b=a.readUint8(),this.seq_profile=b>>5&7,this.seq_level_idx_0=31&b,b=a.readUint8(),this.seq_tier_0=b>>7&1,this.high_bitdepth=b>>6&1,this.twelve_bit=b>>5&1,this.monochrome=b>>4&1,this.chroma_subsampling_x=b>>3&1,this.chroma_subsampling_y=b>>2&1,this.chroma_sample_position=3&b,b=a.readUint8(),this.reserved_1=b>>5&7,0!==this.reserved_1)return void Log.error("av1C reserved_1 parsing problem");if(this.initial_presentation_delay_present=b>>4&1,1===this.initial_presentation_delay_present)this.initial_presentation_delay_minus_one=15&b;else if(this.reserved_2=15&b,0!==this.reserved_2)return void Log.error("av1C reserved_2 parsing problem");var c=this.size-this.hdr_size-4;this.configOBUs=a.readUint8Array(c)}),BoxParser.createBoxCtor("avcC",function(a){var b,c;for(this.configurationVersion=a.readUint8(),this.AVCProfileIndication=a.readUint8(),this.profile_compatibility=a.readUint8(),this.AVCLevelIndication=a.readUint8(),this.lengthSizeMinusOne=3&a.readUint8(),this.nb_SPS_nalus=31&a.readUint8(),c=this.size-this.hdr_size-6,this.SPS=[],b=0;b<this.nb_SPS_nalus;b++)this.SPS[b]={},this.SPS[b].length=a.readUint16(),this.SPS[b].nalu=a.readUint8Array(this.SPS[b].length),c-=2+this.SPS[b].length;for(this.nb_PPS_nalus=a.readUint8(),c--,this.PPS=[],b=0;b<this.nb_PPS_nalus;b++)this.PPS[b]={},this.PPS[b].length=a.readUint16(),this.PPS[b].nalu=a.readUint8Array(this.PPS[b].length),c-=2+this.PPS[b].length;c>0&&(this.ext=a.readUint8Array(c))}),BoxParser.createBoxCtor("btrt",function(a){this.bufferSizeDB=a.readUint32(),this.maxBitrate=a.readUint32(),this.avgBitrate=a.readUint32()}),BoxParser.createBoxCtor("clap",function(a){this.cleanApertureWidthN=a.readUint32(),this.cleanApertureWidthD=a.readUint32(),this.cleanApertureHeightN=a.readUint32(),this.cleanApertureHeightD=a.readUint32(),this.horizOffN=a.readUint32(),this.horizOffD=a.readUint32(),this.vertOffN=a.readUint32(),this.vertOffD=a.readUint32()}),BoxParser.createFullBoxCtor("co64",function(a){var b,c;if(b=a.readUint32(),this.chunk_offsets=[],0===this.version)for(c=0;c<b;c++)this.chunk_offsets.push(a.readUint64())}),BoxParser.createBoxCtor("colr",function(a){if(this.colour_type=a.readString(4),"nclx"===this.colour_type){this.colour_primaries=a.readUint16(),this.transfer_characteristics=a.readUint16(),this.matrix_coefficients=a.readUint16();var b=a.readUint8();this.full_range_flag=b>>7}else"rICC"===this.colour_type?this.ICC_profile=a.readUint8Array(this.size-4):"prof"===this.colour_type&&(this.ICC_profile=a.readUint8Array(this.size-4))}),BoxParser.createFullBoxCtor("cprt",function(a){this.parseLanguage(a),this.notice=a.readCString()}),BoxParser.createFullBoxCtor("cslg",function(a){0===this.version&&(this.compositionToDTSShift=a.readInt32(),this.leastDecodeToDisplayDelta=a.readInt32(),this.greatestDecodeToDisplayDelta=a.readInt32(),this.compositionStartTime=a.readInt32(),this.compositionEndTime=a.readInt32())}),BoxParser.createFullBoxCtor("ctts",function(a){var b,c;if(b=a.readUint32(),this.sample_counts=[],this.sample_offsets=[],0===this.version)for(c=0;c<b;c++){this.sample_counts.push(a.readUint32());var d=a.readInt32();d<0&&Log.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(d)}else if(1==this.version)for(c=0;c<b;c++)this.sample_counts.push(a.readUint32()),this.sample_offsets.push(a.readInt32())}),BoxParser.createBoxCtor("dac3",function(a){var b=a.readUint8(),c=a.readUint8(),d=a.readUint8();this.fscod=b>>6,this.bsid=b>>1&31,this.bsmod=(1&b)<<2|c>>6&3,this.acmod=c>>3&7,this.lfeon=c>>2&1,this.bit_rate_code=3&c|d>>5&7}),BoxParser.createBoxCtor("dec3",function(a){var b=a.readUint16();this.data_rate=b>>3,this.num_ind_sub=7&b,this.ind_subs=[];for(var c=0;c<this.num_ind_sub+1;c++){var d={};this.ind_subs.push(d);var e=a.readUint8(),f=a.readUint8(),g=a.readUint8();d.fscod=e>>6,d.bsid=e>>1&31,d.bsmod=(1&e)<<4|f>>4&15,d.acmod=f>>1&7,d.lfeon=1&f,d.num_dep_sub=g>>1&15,d.num_dep_sub>0&&(d.chan_loc=(1&g)<<8|a.readUint8())}}),BoxParser.createFullBoxCtor("dfLa",function(a){var b=[],c=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];for(this.parseFullHeader(a);;){var d=a.readUint8(),e=Math.min(127&d,c.length-1);if(e?a.readUint8Array(a.readUint24()):(a.readUint8Array(13),this.samplerate=a.readUint32()>>12,a.readUint8Array(20)),b.push(c[e]),128&d)break}this.numMetadataBlocks=b.length+" ("+b.join(", ")+")"}),BoxParser.createBoxCtor("dimm",function(a){this.bytessent=a.readUint64()}),BoxParser.createBoxCtor("dmax",function(a){this.time=a.readUint32()}),BoxParser.createBoxCtor("dmed",function(a){this.bytessent=a.readUint64()}),BoxParser.createFullBoxCtor("dref",function(a){var b,c;this.entries=[];for(var d=a.readUint32(),e=0;e<d;e++){if(b=BoxParser.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code!==BoxParser.OK)return;c=b.box,this.entries.push(c)}}),BoxParser.createBoxCtor("drep",function(a){this.bytessent=a.readUint64()}),BoxParser.createFullBoxCtor("elng",function(a){this.extended_language=a.readString(this.size-this.hdr_size)}),BoxParser.createFullBoxCtor("elst",function(a){this.entries=[];for(var b=a.readUint32(),c=0;c<b;c++){var d={};this.entries.push(d),1===this.version?(d.segment_duration=a.readUint64(),d.media_time=a.readInt64()):(d.segment_duration=a.readUint32(),d.media_time=a.readInt32()),d.media_rate_integer=a.readInt16(),d.media_rate_fraction=a.readInt16()}}),BoxParser.createFullBoxCtor("emsg",function(a){this.scheme_id_uri=a.readCString(),this.value=a.readCString(),this.timescale=a.readUint32(),this.presentation_time_delta=a.readUint32(),this.event_duration=a.readUint32(),this.id=a.readUint32();var b=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));this.message_data=a.readUint8Array(b)}),BoxParser.createFullBoxCtor("esds",function(a){var b=a.readUint8Array(this.size-this.hdr_size);if(void 0!==MPEG4DescriptorParser){var c=new MPEG4DescriptorParser;this.esd=c.parseOneDescriptor(new DataStream(b.buffer,0,DataStream.BIG_ENDIAN))}}),BoxParser.createBoxCtor("fiel",function(a){this.fieldCount=a.readUint8(),this.fieldOrdering=a.readUint8()}),BoxParser.createBoxCtor("frma",function(a){this.data_format=a.readString(4)}),BoxParser.createBoxCtor("ftyp",function(a){var b=this.size-this.hdr_size;this.major_brand=a.readString(4),this.minor_version=a.readUint32(),b-=8,this.compatible_brands=[];for(var c=0;b>=4;)this.compatible_brands[c]=a.readString(4),b-=4,c++}),BoxParser.createFullBoxCtor("hdlr",function(a){0===this.version&&(a.readUint32(),this.handler=a.readString(4),a.readUint32Array(3),this.name=a.readString(this.size-this.hdr_size-20),"\0"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))}),BoxParser.createBoxCtor("hvcC",function(a){var b,c,d,e;this.configurationVersion=a.readUint8(),e=a.readUint8(),this.general_profile_space=e>>6,this.general_tier_flag=(32&e)>>5,this.general_profile_idc=31&e,this.general_profile_compatibility=a.readUint32(),this.general_constraint_indicator=a.readUint8Array(6),this.general_level_idc=a.readUint8(),this.min_spatial_segmentation_idc=4095&a.readUint16(),this.parallelismType=3&a.readUint8(),this.chroma_format_idc=3&a.readUint8(),this.bit_depth_luma_minus8=7&a.readUint8(),this.bit_depth_chroma_minus8=7&a.readUint8(),this.avgFrameRate=a.readUint16(),e=a.readUint8(),this.constantFrameRate=e>>6,this.numTemporalLayers=(13&e)>>3,this.temporalIdNested=(4&e)>>2,this.lengthSizeMinusOne=3&e,this.nalu_arrays=[];var f=a.readUint8();for(b=0;b<f;b++){var g=[];this.nalu_arrays.push(g),e=a.readUint8(),g.completeness=(128&e)>>7,g.nalu_type=63&e;var h=a.readUint16();for(c=0;c<h;c++){var i={};g.push(i),d=a.readUint16(),i.data=a.readUint8Array(d)}}}),BoxParser.createFullBoxCtor("iinf",function(a){var b;0===this.version?this.entry_count=a.readUint16():this.entry_count=a.readUint32(),this.item_infos=[];for(var c=0;c<this.entry_count;c++){if(b=BoxParser.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),b.code!==BoxParser.OK)return;"infe"!==b.box.type&&Log.error("BoxParser","Expected 'infe' box, got "+b.box.type),this.item_infos[c]=b.box}}),BoxParser.createFullBoxCtor("iloc",function(a){var b;b=a.readUint8(),this.offset_size=b>>4&15,this.length_size=15&b,b=a.readUint8(),this.base_offset_size=b>>4&15,1===this.version||2===this.version?this.index_size=15&b:this.index_size=0,this.items=[];var c=0;if(this.version<2)c=a.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";c=a.readUint32()}for(var d=0;d<c;d++){var e={};if(this.items.push(e),this.version<2)e.item_ID=a.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";e.item_ID=a.readUint16()}switch(1!==this.version&&2!==this.version||(e.construction_method=15&a.readUint16()),e.data_reference_index=a.readUint16(),this.base_offset_size){case 0:e.base_offset=0;break;case 4:e.base_offset=a.readUint32();break;case 8:e.base_offset=a.readUint64();break;default:throw"Error reading base offset size"}var f=a.readUint16();e.extents=[];for(var g=0;g<f;g++){var h={};if(e.extents.push(h),1===this.version||2===this.version)switch(this.index_size){case 0:h.extent_index=0;break;case 4:h.extent_index=a.readUint32();break;case 8:h.extent_index=a.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:h.extent_offset=0;break;case 4:h.extent_offset=a.readUint32();break;case 8:h.extent_offset=a.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:h.extent_length=0;break;case 4:h.extent_length=a.readUint32();break;case 8:h.extent_length=a.readUint64();break;default:throw"Error reading extent index"}}}}),BoxParser.createFullBoxCtor("infe",function(a){if(0!==this.version&&1!==this.version||(this.item_ID=a.readUint16(),this.item_protection_index=a.readUint16(),this.item_name=a.readCString(),this.content_type=a.readCString(),this.content_encoding=a.readCString()),1===this.version)return this.extension_type=a.readString(4),Log.warn("BoxParser","Cannot parse extension type"),void a.seek(this.start+this.size);this.version>=2&&(2===this.version?this.item_ID=a.readUint16():3===this.version&&(this.item_ID=a.readUint32()),this.item_protection_index=a.readUint16(),this.item_type=a.readString(4),this.item_name=a.readCString(),"mime"===this.item_type?(this.content_type=a.readCString(),this.content_encoding=a.readCString()):"uri "===this.item_type&&(this.item_uri_type=a.readCString()))}),BoxParser.createFullBoxCtor("ipma",function(a){var b,c;for(entry_count=a.readUint32(),this.associations=[],b=0;b<entry_count;b++){var d={};this.associations.push(d),this.version<1?d.id=a.readUint16():d.id=a.readUint32();var e=a.readUint8();for(d.props=[],c=0;c<e;c++){var f=a.readUint8(),g=[];d.props.push(g);var h,i=(128&f)>>7;h=1&this.flags?(127&f)<<8|a.readUint8():127&f,g.push(h),g.push(1===i)}}}),BoxParser.createFullBoxCtor("iref",function(a){var b,c;for(this.references=[];a.getPosition()<this.start+this.size;){if(b=BoxParser.parseOneBox(a,!0,this.size-(a.getPosition()-this.start)),b.code!==BoxParser.OK)return;c=0===this.version?new BoxParser.SingleItemTypeReferenceBox(b.type,b.size,b.hdr_size,b.start):new BoxParser.SingleItemTypeReferenceBoxLarge(b.type,b.size,b.hdr_size,b.start),c.write===BoxParser.Box.prototype.write&&"mdat"!==c.type&&(Log.warn("BoxParser",c.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),c.parseDataAndRewind(a)),c.parse(a),this.references.push(c)}}),BoxParser.createFullBoxCtor("ispe",function(a){this.image_width=a.readUint32(),this.image_height=a.readUint32()}),BoxParser.createFullBoxCtor("kind",function(a){this.schemeURI=a.readCString(),this.value=a.readCString()}),BoxParser.createFullBoxCtor("leva",function(a){var b=a.readUint8();this.levels=[];for(var c=0;c<b;c++){var d={};this.levels[c]=d,d.track_ID=a.readUint32();var e=a.readUint8();switch(d.padding_flag=e>>7,d.assignment_type=127&e,d.assignment_type){case 0:d.grouping_type=a.readString(4);break;case 1:d.grouping_type=a.readString(4),d.grouping_type_parameter=a.readUint32();break;case 2:case 3:break;case 4:d.sub_track_id=a.readUint32();break;default:Log.warn("BoxParser","Unknown leva assignement type")}}}),BoxParser.createBoxCtor("maxr",function(a){this.period=a.readUint32(),this.bytes=a.readUint32()}),BoxParser.createFullBoxCtor("mdhd",function(a){1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.timescale=a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.timescale=a.readUint32(),this.duration=a.readUint32()),this.parseLanguage(a),a.readUint16()}),BoxParser.createFullBoxCtor("mehd",function(a){1&this.flags&&(Log.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1==this.version?this.fragment_duration=a.readUint64():this.fragment_duration=a.readUint32()}),BoxParser.createFullBoxCtor("meta",function(a){this.boxes=[],BoxParser.ContainerBox.prototype.parse.call(this,a)}),BoxParser.createFullBoxCtor("mfhd",function(a){this.sequence_number=a.readUint32()}),BoxParser.createFullBoxCtor("mfro",function(a){this._size=a.readUint32()}),BoxParser.createFullBoxCtor("mvhd",function(a){1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.timescale=a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.timescale=a.readUint32(),this.duration=a.readUint32()),this.rate=a.readUint32(),this.volume=a.readUint16()>>8,a.readUint16(),a.readUint32Array(2),this.matrix=a.readUint32Array(9),a.readUint32Array(6),this.next_track_id=a.readUint32()}),BoxParser.createBoxCtor("npck",function(a){this.packetssent=a.readUint32()}),BoxParser.createBoxCtor("nump",function(a){this.packetssent=a.readUint64()}),BoxParser.createFullBoxCtor("padb",function(a){var b=a.readUint32();this.padbits=[];for(var c=0;c<Math.floor((b+1)/2);c++)this.padbits=a.readUint8()}),BoxParser.createBoxCtor("pasp",function(a){this.hSpacing=a.readUint32(),this.vSpacing=a.readUint32()}),BoxParser.createBoxCtor("payl",function(a){this.text=a.readString(this.size-this.hdr_size)}),BoxParser.createBoxCtor("payt",function(a){this.payloadID=a.readUint32();var b=a.readUint8();this.rtpmap_string=a.readString(b)}),BoxParser.createFullBoxCtor("pdin",function(a){var b=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var c=0;c<b;c++)this.rate[c]=a.readUint32(),this.initial_delay[c]=a.readUint32()}),BoxParser.createFullBoxCtor("pitm",function(a){0===this.version?this.item_id=a.readUint16():this.item_id=a.readUint32()}),BoxParser.createFullBoxCtor("pixi",function(a){var b;for(this.num_channels=a.readUint8(),this.bits_per_channels=[],b=0;b<this.num_channels;b++)this.bits_per_channels[b]=a.readUint8()}),BoxParser.createBoxCtor("pmax",function(a){this.bytes=a.readUint32()}),BoxParser.createFullBoxCtor("prft",function(a){this.ref_track_id=a.readUint32(),this.ntp_timestamp=a.readUint64(),0===this.version?this.media_time=a.readUint32():this.media_time=a.readUint64()}),BoxParser.createFullBoxCtor("pssh",function(a){if(this.system_id=BoxParser.parseHex16(a),this.version>0){var b=a.readUint32();this.kid=[];for(var c=0;c<b;c++)this.kid[c]=BoxParser.parseHex16(a)}var d=a.readUint32();d>0&&(this.data=a.readUint8Array(d))}),BoxParser.createBoxCtor("rtp ",function(a){this.descriptionformat=a.readString(4),this.sdptext=a.readString(this.size-this.hdr_size-4)}),BoxParser.createFullBoxCtor("saio",function(a){1&this.flags&&(this.aux_info_type=a.readUint32(),this.aux_info_type_parameter=a.readUint32());var b=a.readUint32();this.offset=[];for(var c=0;c<b;c++)0===this.version?this.offset[c]=a.readUint32():this.offset[c]=a.readUint64()}),BoxParser.createFullBoxCtor("saiz",function(a){1&this.flags&&(this.aux_info_type=a.readUint32(),this.aux_info_type_parameter=a.readUint32()),this.default_sample_info_size=a.readUint8();var b=a.readUint32();if(this.sample_info_size=[],0===this.default_sample_info_size)for(var c=0;c<b;c++)this.sample_info_size[c]=a.readUint8()}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(a){this.parseHeader(a),this.content_encoding=a.readCString(),this.mime_format=a.readCString(),this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(a){this.parseHeader(a),this.content_encoding=a.readCString(),this.namespace=a.readCString(),this.schema_location=a.readCString(),this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(a){this.parseHeader(a),this.content_encoding=a.readCString(),this.mime_format=a.readCString(),this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(a){this.parseHeader(a),this.namespace=a.readCString(),this.schema_location=a.readCString(),this.auxiliary_mime_types=a.readCString(),this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(a){this.parseHeader(a),this.content_encoding=a.readCString(),this.mime_format=a.readCString(),this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(a){this.parseHeader(a),this.displayFlags=a.readUint32(),this.horizontal_justification=a.readInt8(),this.vertical_justification=a.readInt8(),this.bg_color_rgba=a.readUint8Array(4),this.box_record=a.readInt16Array(4),this.style_record=a.readUint8Array(12),this.parseFooter(a)}),BoxParser.createSampleEntryCtor(BoxParser.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(a){this.parseHeader(a),this.parseFooter(a)}),BoxParser.createSampleGroupCtor("alst",function(a){var b,c=a.readUint16();for(this.first_output_sample=a.readUint16(),this.sample_offset=[],b=0;b<c;b++)this.sample_offset[b]=a.readUint32();var d=this.description_length-4-4*c;for(this.num_output_samples=[],this.num_total_samples=[],b=0;b<d/4;b++)this.num_output_samples[b]=a.readUint16(),this.num_total_samples[b]=a.readUint16()}),BoxParser.createSampleGroupCtor("avll",function(a){this.layerNumber=a.readUint8(),this.accurateStatisticsFlag=a.readUint8(),this.avgBitRate=a.readUint16(),this.avgFrameRate=a.readUint16()}),BoxParser.createSampleGroupCtor("avss",function(a){this.subSequenceIdentifier=a.readUint16(),this.layerNumber=a.readUint8();var b=a.readUint8();this.durationFlag=b>>7,this.avgRateFlag=b>>6&1,this.durationFlag&&(this.duration=a.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=a.readUint8(),this.avgBitRate=a.readUint16(),this.avgFrameRate=a.readUint16()),this.dependency=[];for(var c=a.readUint8(),d=0;d<c;d++){var e={};this.dependency.push(e),e.subSeqDirectionFlag=a.readUint8(),e.layerNumber=a.readUint8(),e.subSequenceIdentifier=a.readUint16()}}),BoxParser.createSampleGroupCtor("dtrt",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("mvif",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("prol",function(a){this.roll_distance=a.readInt16()}),BoxParser.createSampleGroupCtor("rap ",function(a){var b=a.readUint8();this.num_leading_samples_known=b>>7,this.num_leading_samples=127&b}),BoxParser.createSampleGroupCtor("rash",function(a){if(this.operation_point_count=a.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)Log.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=a.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=a.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var b=0;b<this.operation_point_count;b++)this.available_bitrate[b]=a.readUint32(),this.target_rate_share[b]=a.readUint16()}this.maximum_bitrate=a.readUint32(),this.minimum_bitrate=a.readUint32(),this.discard_priority=a.readUint8()}}),BoxParser.createSampleGroupCtor("roll",function(a){this.roll_distance=a.readInt16()}),BoxParser.SampleGroupEntry.prototype.parse=function(a){Log.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=a.readUint8Array(this.description_length)},BoxParser.createSampleGroupCtor("scif",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("scnm",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("seig",function(a){this.reserved=a.readUint8();var b=a.readUint8();this.crypt_byte_block=b>>4,this.skip_byte_block=15&b,this.isProtected=a.readUint8(),this.Per_Sample_IV_Size=a.readUint8(),this.KID=BoxParser.parseHex16(a),this.constant_IV_size=0,this.constant_IV=0,1===this.isProtected&&0===this.Per_Sample_IV_Size&&(this.constant_IV_size=a.readUint8(),this.constant_IV=a.readUint8Array(this.constant_IV_size))}),BoxParser.createSampleGroupCtor("stsa",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("sync",function(a){var b=a.readUint8();this.NAL_unit_type=63&b}),BoxParser.createSampleGroupCtor("tele",function(a){var b=a.readUint8()
;this.level_independently_decodable=b>>7}),BoxParser.createSampleGroupCtor("tsas",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("tscl",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createSampleGroupCtor("vipr",function(a){Log.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),BoxParser.createFullBoxCtor("sbgp",function(a){this.grouping_type=a.readString(4),1===this.version?this.grouping_type_parameter=a.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var b=a.readUint32(),c=0;c<b;c++){var d={};this.entries.push(d),d.sample_count=a.readInt32(),d.group_description_index=a.readInt32()}}),BoxParser.createFullBoxCtor("schm",function(a){this.scheme_type=a.readString(4),this.scheme_version=a.readUint32(),1&this.flags&&(this.scheme_uri=a.readString(this.size-this.hdr_size-8))}),BoxParser.createBoxCtor("sdp ",function(a){this.sdptext=a.readString(this.size-this.hdr_size)}),BoxParser.createFullBoxCtor("sdtp",function(a){var b,c=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var d=0;d<c;d++)b=a.readUint8(),this.is_leading[d]=b>>6,this.sample_depends_on[d]=b>>4&3,this.sample_is_depended_on[d]=b>>2&3,this.sample_has_redundancy[d]=3&b}),BoxParser.createFullBoxCtor("senc"),BoxParser.createFullBoxCtor("sgpd",function(a){this.grouping_type=a.readString(4),Log.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=a.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=a.readUint32()),this.entries=[];for(var b=a.readUint32(),c=0;c<b;c++){var d;d=BoxParser[this.grouping_type+"SampleGroupEntry"]?new BoxParser[this.grouping_type+"SampleGroupEntry"](this.grouping_type):new BoxParser.SampleGroupEntry(this.grouping_type),this.entries.push(d),1===this.version&&0===this.default_length?d.description_length=a.readUint32():d.description_length=this.default_length,d.write===BoxParser.SampleGroupEntry.prototype.write&&(Log.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),d.data=a.readUint8Array(d.description_length),a.position-=d.description_length),d.parse(a)}}),BoxParser.createFullBoxCtor("sidx",function(a){this.reference_ID=a.readUint32(),this.timescale=a.readUint32(),0===this.version?(this.earliest_presentation_time=a.readUint32(),this.first_offset=a.readUint32()):(this.earliest_presentation_time=a.readUint64(),this.first_offset=a.readUint64()),a.readUint16(),this.references=[];for(var b=a.readUint16(),c=0;c<b;c++){var d={};this.references.push(d);var e=a.readUint32();d.reference_type=e>>31&1,d.referenced_size=2147483647&e,d.subsegment_duration=a.readUint32(),e=a.readUint32(),d.starts_with_SAP=e>>31&1,d.SAP_type=e>>28&7,d.SAP_delta_time=268435455&e}}),BoxParser.SingleItemTypeReferenceBox=function(a,b,c,d){BoxParser.Box.call(this,a,b),this.hdr_size=c,this.start=d},BoxParser.SingleItemTypeReferenceBox.prototype=new BoxParser.Box,BoxParser.SingleItemTypeReferenceBox.prototype.parse=function(a){this.from_item_ID=a.readUint16();var b=a.readUint16();this.references=[];for(var c=0;c<b;c++)this.references[c]=a.readUint16()},BoxParser.SingleItemTypeReferenceBoxLarge=function(a,b,c,d){BoxParser.Box.call(this,a,b),this.hdr_size=c,this.start=d},BoxParser.SingleItemTypeReferenceBoxLarge.prototype=new BoxParser.Box,BoxParser.SingleItemTypeReferenceBoxLarge.prototype.parse=function(a){this.from_item_ID=a.readUint32();var b=a.readUint16();this.references=[];for(var c=0;c<b;c++)this.references[c]=a.readUint32()},BoxParser.createFullBoxCtor("smhd",function(a){this.balance=a.readUint16(),a.readUint16()}),BoxParser.createFullBoxCtor("ssix",function(a){this.subsegments=[];for(var b=a.readUint32(),c=0;c<b;c++){var d={};this.subsegments.push(d),d.ranges=[];for(var e=a.readUint32(),f=0;f<e;f++){var g={};d.ranges.push(g),g.level=a.readUint8(),g.range_size=a.readUint24()}}}),BoxParser.createFullBoxCtor("stco",function(a){var b;if(b=a.readUint32(),this.chunk_offsets=[],0===this.version)for(var c=0;c<b;c++)this.chunk_offsets.push(a.readUint32())}),BoxParser.createFullBoxCtor("stdp",function(a){var b=(this.size-this.hdr_size)/2;this.priority=[];for(var c=0;c<b;c++)this.priority[c]=a.readUint16()}),BoxParser.createFullBoxCtor("sthd"),BoxParser.createFullBoxCtor("stri",function(a){this.switch_group=a.readUint16(),this.alternate_group=a.readUint16(),this.sub_track_id=a.readUint32();var b=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var c=0;c<b;c++)this.attribute_list[c]=a.readUint32()}),BoxParser.createFullBoxCtor("stsc",function(a){var b,c;if(b=a.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(c=0;c<b;c++)this.first_chunk.push(a.readUint32()),this.samples_per_chunk.push(a.readUint32()),this.sample_description_index.push(a.readUint32())}),BoxParser.createFullBoxCtor("stsd",function(a){var b,c,d,e;for(this.entries=[],d=a.readUint32(),b=1;b<=d;b++){if(c=BoxParser.parseOneBox(a,!0,this.size-(a.getPosition()-this.start)),c.code!==BoxParser.OK)return;BoxParser[c.type+"SampleEntry"]?(e=new BoxParser[c.type+"SampleEntry"](c.size),e.hdr_size=c.hdr_size,e.start=c.start):(Log.warn("BoxParser","Unknown sample entry type: "+c.type),e=new BoxParser.SampleEntry(c.type,c.size,c.hdr_size,c.start)),e.write===BoxParser.SampleEntry.prototype.write&&(Log.info("BoxParser","SampleEntry "+e.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),e.parseDataAndRewind(a)),e.parse(a),this.entries.push(e)}}),BoxParser.createFullBoxCtor("stsg",function(a){this.grouping_type=a.readUint32();var b=a.readUint16();this.group_description_index=[];for(var c=0;c<b;c++)this.group_description_index[c]=a.readUint32()}),BoxParser.createFullBoxCtor("stsh",function(a){var b,c;if(b=a.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(c=0;c<b;c++)this.shadowed_sample_numbers.push(a.readUint32()),this.sync_sample_numbers.push(a.readUint32())}),BoxParser.createFullBoxCtor("stss",function(a){var b,c;if(c=a.readUint32(),0===this.version)for(this.sample_numbers=[],b=0;b<c;b++)this.sample_numbers.push(a.readUint32())}),BoxParser.createFullBoxCtor("stsz",function(a){var b;if(this.sample_sizes=[],0===this.version)for(this.sample_size=a.readUint32(),this.sample_count=a.readUint32(),b=0;b<this.sample_count;b++)0===this.sample_size?this.sample_sizes.push(a.readUint32()):this.sample_sizes[b]=this.sample_size}),BoxParser.createFullBoxCtor("stts",function(a){var b,c,d;if(b=a.readUint32(),this.sample_counts=[],this.sample_deltas=[],0===this.version)for(c=0;c<b;c++)this.sample_counts.push(a.readUint32()),d=a.readInt32(),d<0&&(Log.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),d=1),this.sample_deltas.push(d)}),BoxParser.createFullBoxCtor("stvi",function(a){var b=a.readUint32();this.single_view_allowed=3&b,this.stereo_scheme=a.readUint32();var c=a.readUint32();this.stereo_indication_type=a.readString(c);var d,e;for(this.boxes=[];a.getPosition()<this.start+this.size;){if(d=BoxParser.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),d.code!==BoxParser.OK)return;e=d.box,this.boxes.push(e),this[e.type]=e}}),BoxParser.createBoxCtor("styp",function(a){BoxParser.ftypBox.prototype.parse.call(this,a)}),BoxParser.createFullBoxCtor("stz2",function(a){var b,c;if(this.sample_sizes=[],0===this.version)if(this.reserved=a.readUint24(),this.field_size=a.readUint8(),c=a.readUint32(),4===this.field_size)for(b=0;b<c;b+=2){var d=a.readUint8();this.sample_sizes[b]=d>>4&15,this.sample_sizes[b+1]=15&d}else if(8===this.field_size)for(b=0;b<c;b++)this.sample_sizes[b]=a.readUint8();else if(16===this.field_size)for(b=0;b<c;b++)this.sample_sizes[b]=a.readUint16();else Log.error("BoxParser","Error in length field in stz2 box")}),BoxParser.createFullBoxCtor("subs",function(a){var b,c,d,e;for(d=a.readUint32(),this.entries=[],b=0;b<d;b++){var f={};if(this.entries[b]=f,f.sample_delta=a.readUint32(),f.subsamples=[],(e=a.readUint16())>0)for(c=0;c<e;c++){var g={};f.subsamples.push(g),1==this.version?g.size=a.readUint32():g.size=a.readUint16(),g.priority=a.readUint8(),g.discardable=a.readUint8(),g.codec_specific_parameters=a.readUint32()}}}),BoxParser.createFullBoxCtor("tenc",function(a){if(a.readUint8(),0===this.version)a.readUint8();else{var b=a.readUint8();this.default_crypt_byte_block=b>>4&15,this.default_skip_byte_block=15&b}this.default_isProtected=a.readUint8(),this.default_Per_Sample_IV_Size=a.readUint8(),this.default_KID=BoxParser.parseHex16(a),1===this.default_isProtected&&0===this.default_Per_Sample_IV_Size&&(this.default_constant_IV_size=a.readUint8(),this.default_constant_IV=a.readUint8Array(this.default_constant_IV_size))}),BoxParser.createFullBoxCtor("tfdt",function(a){1==this.version?this.baseMediaDecodeTime=a.readUint64():this.baseMediaDecodeTime=a.readUint32()}),BoxParser.createFullBoxCtor("tfhd",function(a){var b=0;this.track_id=a.readUint32(),this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=a.readUint64(),b+=8):this.base_data_offset=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=a.readUint32(),b+=4):this.default_sample_description_index=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=a.readUint32(),b+=4):this.default_sample_duration=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=a.readUint32(),b+=4):this.default_sample_size=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=a.readUint32(),b+=4):this.default_sample_flags=0}),BoxParser.createFullBoxCtor("tfra",function(a){this.track_ID=a.readUint32(),a.readUint24();var b=a.readUint8();this.length_size_of_traf_num=b>>4&3,this.length_size_of_trun_num=b>>2&3,this.length_size_of_sample_num=3&b,this.entries=[];for(var c=a.readUint32(),d=0;d<c;d++)1===this.version?(this.time=a.readUint64(),this.moof_offset=a.readUint64()):(this.time=a.readUint32(),this.moof_offset=a.readUint32()),this.traf_number=a["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=a["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=a["readUint"+8*(this.length_size_of_sample_num+1)]()}),BoxParser.createFullBoxCtor("tkhd",function(a){1==this.version?(this.creation_time=a.readUint64(),this.modification_time=a.readUint64(),this.track_id=a.readUint32(),a.readUint32(),this.duration=a.readUint64()):(this.creation_time=a.readUint32(),this.modification_time=a.readUint32(),this.track_id=a.readUint32(),a.readUint32(),this.duration=a.readUint32()),a.readUint32Array(2),this.layer=a.readInt16(),this.alternate_group=a.readInt16(),this.volume=a.readInt16()>>8,a.readUint16(),this.matrix=a.readInt32Array(9),this.width=a.readUint32(),this.height=a.readUint32()}),BoxParser.createBoxCtor("tmax",function(a){this.time=a.readUint32()}),BoxParser.createBoxCtor("tmin",function(a){this.time=a.readUint32()}),BoxParser.createBoxCtor("totl",function(a){this.bytessent=a.readUint32()}),BoxParser.createBoxCtor("tpay",function(a){this.bytessent=a.readUint32()}),BoxParser.createBoxCtor("tpyl",function(a){this.bytessent=a.readUint64()}),BoxParser.createTrackGroupCtor("msrc"),BoxParser.trefBox.prototype.parse=function(a){for(var b,c;a.getPosition()<this.start+this.size;){if(b=BoxParser.parseOneBox(a,!0,this.size-(a.getPosition()-this.start)),b.code!==BoxParser.OK)return;c=new BoxParser.TrackReferenceTypeBox(b.type,b.size,b.hdr_size,b.start),c.write===BoxParser.Box.prototype.write&&"mdat"!==c.type&&(Log.info("BoxParser","TrackReference "+c.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),c.parseDataAndRewind(a)),c.parse(a),this.boxes.push(c)}},BoxParser.createFullBoxCtor("trep",function(a){for(this.track_ID=a.readUint32(),this.boxes=[];a.getPosition()<this.start+this.size;){if(ret=BoxParser.parseOneBox(a,!1,this.size-(a.getPosition()-this.start)),ret.code!==BoxParser.OK)return;box=ret.box,this.boxes.push(box)}}),BoxParser.createFullBoxCtor("trex",function(a){this.track_id=a.readUint32(),this.default_sample_description_index=a.readUint32(),this.default_sample_duration=a.readUint32(),this.default_sample_size=a.readUint32(),this.default_sample_flags=a.readUint32()}),BoxParser.createBoxCtor("trpy",function(a){this.bytessent=a.readUint64()}),BoxParser.createFullBoxCtor("trun",function(a){var b=0;if(this.sample_count=a.readUint32(),b+=4,this.size-this.hdr_size>b&&this.flags&BoxParser.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=a.readInt32(),b+=4):this.data_offset=0,this.size-this.hdr_size>b&&this.flags&BoxParser.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=a.readUint32(),b+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>b)for(var c=0;c<this.sample_count;c++)this.flags&BoxParser.TRUN_FLAGS_DURATION&&(this.sample_duration[c]=a.readUint32()),this.flags&BoxParser.TRUN_FLAGS_SIZE&&(this.sample_size[c]=a.readUint32()),this.flags&BoxParser.TRUN_FLAGS_FLAGS&&(this.sample_flags[c]=a.readUint32()),this.flags&BoxParser.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[c]=a.readUint32():this.sample_composition_time_offset[c]=a.readInt32())}),BoxParser.createFullBoxCtor("tsel",function(a){this.switch_group=a.readUint32();var b=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var c=0;c<b;c++)this.attribute_list[c]=a.readUint32()}),BoxParser.createFullBoxCtor("txtC",function(a){this.config=a.readCString()}),BoxParser.createFullBoxCtor("url ",function(a){1!==this.flags&&(this.location=a.readCString())}),BoxParser.createFullBoxCtor("urn ",function(a){this.name=a.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=a.readCString())});BoxParser.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(a){this.system_id=BoxParser.parseHex16(a);var b=a.readUint32();b>0&&(this.data=a.readUint8Array(b))}),BoxParser.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),BoxParser.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(a){this.default_AlgorithmID=a.readUint24(),this.default_IV_size=a.readUint8(),this.default_KID=BoxParser.parseHex16(a)}),BoxParser.createFullBoxCtor("vmhd",function(a){this.graphicsmode=a.readUint16(),this.opcolor=a.readUint16Array(3)}),BoxParser.createFullBoxCtor("vpcC",function(a){var b;1===this.version?(this.profile=a.readUint8(),this.level=a.readUint8(),b=a.readUint8(),this.bitDepth=b>>4,this.chromaSubsampling=b>>1&7,this.videoFullRangeFlag=1&b,this.colourPrimaries=a.readUint8(),this.transferCharacteristics=a.readUint8(),this.matrixCoefficients=a.readUint8(),this.codecIntializationDataSize=a.readUint16(),this.codecIntializationData=a.readUint8Array(this.codecIntializationDataSize)):(this.profile=a.readUint8(),this.level=a.readUint8(),b=a.readUint8(),this.bitDepth=b>>4&15,this.colorSpace=15&b,b=a.readUint8(),this.chromaSubsampling=b>>4&15,this.transferFunction=b>>1&7,this.videoFullRangeFlag=1&b,this.codecIntializationDataSize=a.readUint16(),this.codecIntializationData=a.readUint8Array(this.codecIntializationDataSize))}),BoxParser.createBoxCtor("vttC",function(a){this.text=a.readString(this.size-this.hdr_size)}),BoxParser.SampleEntry.prototype.isVideo=function(){return!1},BoxParser.SampleEntry.prototype.isAudio=function(){return!1},BoxParser.SampleEntry.prototype.isSubtitle=function(){return!1},BoxParser.SampleEntry.prototype.isMetadata=function(){return!1},BoxParser.SampleEntry.prototype.isHint=function(){return!1},BoxParser.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},BoxParser.SampleEntry.prototype.getWidth=function(){return""},BoxParser.SampleEntry.prototype.getHeight=function(){return""},BoxParser.SampleEntry.prototype.getChannelCount=function(){return""},BoxParser.SampleEntry.prototype.getSampleRate=function(){return""},BoxParser.SampleEntry.prototype.getSampleSize=function(){return""},BoxParser.VisualSampleEntry.prototype.isVideo=function(){return!0},BoxParser.VisualSampleEntry.prototype.getWidth=function(){return this.width},BoxParser.VisualSampleEntry.prototype.getHeight=function(){return this.height},BoxParser.AudioSampleEntry.prototype.isAudio=function(){return!0},BoxParser.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},BoxParser.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},BoxParser.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},BoxParser.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},BoxParser.MetadataSampleEntry.prototype.isMetadata=function(){return!0},BoxParser.decimalToHex=function(a,b){var c=Number(a).toString(16);for(b=void 0===b||null===b?b=2:b;c.length<b;)c="0"+c;return c},BoxParser.avc1SampleEntry.prototype.getCodec=function(){var a=BoxParser.SampleEntry.prototype.getCodec.call(this);return this.avcC?a+"."+BoxParser.decimalToHex(this.avcC.AVCProfileIndication)+BoxParser.decimalToHex(this.avcC.profile_compatibility)+BoxParser.decimalToHex(this.avcC.AVCLevelIndication):a},BoxParser.hvc1SampleEntry.prototype.getCodec=function(){var a,b=BoxParser.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(b+=".",this.hvcC.general_profile_space){case 0:b+="";break;case 1:b+="A";break;case 2:b+="B";break;case 3:b+="C"}b+=this.hvcC.general_profile_idc,b+=".";var c=this.hvcC.general_profile_compatibility,d=0;for(a=0;a<32&&(d|=1&c,31!=a);a++)d<<=1,c>>=1;b+=BoxParser.decimalToHex(d,0),b+=".",0===this.hvcC.general_tier_flag?b+="L":b+="H",b+=this.hvcC.general_level_idc;var e=!1,f="";for(a=5;a>=0;a--)(this.hvcC.general_constraint_indicator[a]||e)&&(f="."+BoxParser.decimalToHex(this.hvcC.general_constraint_indicator[a],0)+f,e=!0);b+=f}return b},BoxParser.mp4aSampleEntry.prototype.getCodec=function(){var a=BoxParser.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var b=this.esds.esd.getOTI(),c=this.esds.esd.getAudioConfig();return a+"."+BoxParser.decimalToHex(b)+(c?"."+c:"")}return a},BoxParser.stxtSampleEntry.prototype.getCodec=function(){var a=BoxParser.SampleEntry.prototype.getCodec.call(this);return this.mime_format?a+"."+this.mime_format:a},BoxParser.av01SampleEntry.prototype.getCodec=function(){var a,b=BoxParser.SampleEntry.prototype.getCodec.call(this);return 2===this.av1C.seq_profile&&1===this.av1C.high_bitdepth?a=1===this.av1C.twelve_bit?12:10:this.av1C.seq_profile<=2&&(a=1===this.av1C.high_bitdepth?10:8),b+"."+this.av1C.seq_profile+"."+this.av1C.seq_level_idx_0+(this.av1C.seq_tier_0?"H":"M")+"."+a+"."+this.av1C.monochrome+"."+this.av1C.chroma_subsampling_x+this.av1C.chroma_subsampling_y+this.av1C.chroma_sample_position},BoxParser.Box.prototype.writeHeader=function(a,b){this.size+=8,this.size>MAX_SIZE&&(this.size+=8),"uuid"===this.type&&(this.size+=16),Log.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+a.getPosition()+(b||"")),this.size>MAX_SIZE?a.writeUint32(1):(this.sizePosition=a.getPosition(),a.writeUint32(this.size)),a.writeString(this.type,null,4),"uuid"===this.type&&a.writeUint8Array(this.uuid),this.size>MAX_SIZE&&a.writeUint64(this.size)},BoxParser.FullBox.prototype.writeHeader=function(a){this.size+=4,BoxParser.Box.prototype.writeHeader.call(this,a," v="+this.version+" f="+this.flags),a.writeUint8(this.version),a.writeUint24(this.flags)},BoxParser.Box.prototype.write=function(a){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(a),a.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(a),this.data&&a.writeUint8Array(this.data))},BoxParser.ContainerBox.prototype.write=function(a){this.size=0,this.writeHeader(a);for(var b=0;b<this.boxes.length;b++)this.boxes[b]&&(this.boxes[b].write(a),this.size+=this.boxes[b].size);Log.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),a.adjustUint32(this.sizePosition,this.size)},BoxParser.TrackReferenceTypeBox.prototype.write=function(a){this.size=4*this.track_ids.length,this.writeHeader(a),a.writeUint32Array(this.track_ids)},BoxParser.avcCBox.prototype.write=function(a){var b;for(this.size=7,b=0;b<this.SPS.length;b++)this.size+=2+this.SPS[b].length;for(b=0;b<this.PPS.length;b++)this.size+=2+this.PPS[b].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(a),a.writeUint8(this.configurationVersion),a.writeUint8(this.AVCProfileIndication),a.writeUint8(this.profile_compatibility),a.writeUint8(this.AVCLevelIndication),a.writeUint8(this.lengthSizeMinusOne+252),a.writeUint8(this.SPS.length+224),b=0;b<this.SPS.length;b++)a.writeUint16(this.SPS[b].length),a.writeUint8Array(this.SPS[b]);for(a.writeUint8(this.PPS.length),b=0;b<this.PPS.length;b++)a.writeUint16(this.PPS[b].length),a.writeUint8Array(this.PPS[b]);this.ext&&a.writeUint8Array(this.ext)},BoxParser.co64Box.prototype.write=function(a){var b;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(a),a.writeUint32(this.chunk_offsets.length),b=0;b<this.chunk_offsets.length;b++)a.writeUint64(this.chunk_offsets[b])},BoxParser.cslgBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=20,this.writeHeader(a),a.writeInt32(this.compositionToDTSShift),a.writeInt32(this.leastDecodeToDisplayDelta),a.writeInt32(this.greatestDecodeToDisplayDelta),a.writeInt32(this.compositionStartTime),a.writeInt32(this.compositionEndTime)},BoxParser.cttsBox.prototype.write=function(a){var b;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(a),a.writeUint32(this.sample_counts.length),b=0;b<this.sample_counts.length;b++)a.writeUint32(this.sample_counts[b]),1===this.version?a.writeInt32(this.sample_offsets[b]):a.writeUint32(this.sample_offsets[b])},BoxParser.drefBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4,this.writeHeader(a),a.writeUint32(this.entries.length);for(var b=0;b<this.entries.length;b++)this.entries[b].write(a),this.size+=this.entries[b].size;Log.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),a.adjustUint32(this.sizePosition,this.size)},BoxParser.elngBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(a),a.writeString(this.extended_language)},BoxParser.elstBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(a),a.writeUint32(this.entries.length);for(var b=0;b<this.entries.length;b++){var c=this.entries[b];a.writeUint32(c.segment_duration),a.writeInt32(c.media_time),a.writeInt16(c.media_rate_integer),a.writeInt16(c.media_rate_fraction)}},BoxParser.emsgBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(a),a.writeCString(this.scheme_id_uri),a.writeCString(this.value),a.writeUint32(this.timescale),a.writeUint32(this.presentation_time_delta),a.writeUint32(this.event_duration),a.writeUint32(this.id),a.writeUint8Array(this.message_data)},BoxParser.ftypBox.prototype.write=function(a){this.size=8+4*this.compatible_brands.length,this.writeHeader(a),a.writeString(this.major_brand,null,4),a.writeUint32(this.minor_version);for(var b=0;b<this.compatible_brands.length;b++)a.writeString(this.compatible_brands[b],null,4)},BoxParser.hdlrBox.prototype.write=function(a){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(a),a.writeUint32(0),a.writeString(this.handler,null,4),a.writeUint32(0),a.writeUint32(0),a.writeUint32(0),a.writeCString(this.name)},BoxParser.kindBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(a),a.writeCString(this.schemeURI),a.writeCString(this.value)},BoxParser.mdhdBox.prototype.write=function(a){this.size=20,this.flags=0,this.version=0,this.writeHeader(a),a.writeUint32(this.creation_time),a.writeUint32(this.modification_time),a.writeUint32(this.timescale),a.writeUint32(this.duration),a.writeUint16(this.language),a.writeUint16(0)},BoxParser.mehdBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4,this.writeHeader(a),a.writeUint32(this.fragment_duration)},BoxParser.mfhdBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4,this.writeHeader(a),a.writeUint32(this.sequence_number)},BoxParser.mvhdBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=96,this.writeHeader(a),a.writeUint32(this.creation_time),a.writeUint32(this.modification_time),a.writeUint32(this.timescale),a.writeUint32(this.duration),a.writeUint32(this.rate),a.writeUint16(this.volume<<8),a.writeUint16(0),a.writeUint32(0),a.writeUint32(0),a.writeUint32Array(this.matrix),a.writeUint32(0),a.writeUint32(0),a.writeUint32(0),a.writeUint32(0),a.writeUint32(0),a.writeUint32(0),a.writeUint32(this.next_track_id)},BoxParser.SampleEntry.prototype.writeHeader=function(a){this.size=8,BoxParser.Box.prototype.writeHeader.call(this,a),a.writeUint8(0),a.writeUint8(0),a.writeUint8(0),a.writeUint8(0),a.writeUint8(0),a.writeUint8(0),a.writeUint16(this.data_reference_index)},BoxParser.SampleEntry.prototype.writeFooter=function(a){for(var b=0;b<this.boxes.length;b++)this.boxes[b].write(a),this.size+=this.boxes[b].size;Log.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),a.adjustUint32(this.sizePosition,this.size)},BoxParser.SampleEntry.prototype.write=function(a){this.writeHeader(a),a.writeUint8Array(this.data),this.size+=this.data.length,Log.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),a.adjustUint32(this.sizePosition,this.size)},BoxParser.VisualSampleEntry.prototype.write=function(a){this.writeHeader(a),this.size+=70,a.writeUint16(0),a.writeUint16(0),a.writeUint32(0),a.writeUint32(0),a.writeUint32(0),a.writeUint16(this.width),a.writeUint16(this.height),a.writeUint32(this.horizresolution),a.writeUint32(this.vertresolution),a.writeUint32(0),a.writeUint16(this.frame_count),a.writeUint8(Math.min(31,this.compressorname.length)),a.writeString(this.compressorname,null,31),a.writeUint16(this.depth),a.writeInt16(-1),this.writeFooter(a)},BoxParser.AudioSampleEntry.prototype.write=function(a){this.writeHeader(a),this.size+=20,a.writeUint32(0),a.writeUint32(0),a.writeUint16(this.channel_count),a.writeUint16(this.samplesize),a.writeUint16(0),a.writeUint16(0),a.writeUint32(this.samplerate<<16),this.writeFooter(a)},BoxParser.stppSampleEntry.prototype.write=function(a){this.writeHeader(a),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,a.writeCString(this.namespace),a.writeCString(this.schema_location),a.writeCString(this.auxiliary_mime_types),this.writeFooter(a)},BoxParser.SampleGroupEntry.prototype.write=function(a){a.writeUint8Array(this.data)},BoxParser.sbgpBox.prototype.write=function(a){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(a),a.writeString(this.grouping_type,null,4),a.writeUint32(this.grouping_type_parameter),a.writeUint32(this.entries.length);for(var b=0;b<this.entries.length;b++){var c=this.entries[b];a.writeInt32(c.sample_count),a.writeInt32(c.group_description_index)}},BoxParser.sgpdBox.prototype.write=function(a){var b,c;for(this.flags=0,this.size=12,b=0;b<this.entries.length;b++)c=this.entries[b],1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=c.data.length);for(this.writeHeader(a),a.writeString(this.grouping_type,null,4),1===this.version&&a.writeUint32(this.default_length),this.version>=2&&a.writeUint32(this.default_sample_description_index),a.writeUint32(this.entries.length),b=0;b<this.entries.length;b++)c=this.entries[b],1===this.version&&0===this.default_length&&a.writeUint32(c.description_length),c.write(a)},BoxParser.sidxBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(a),a.writeUint32(this.reference_ID),a.writeUint32(this.timescale),a.writeUint32(this.earliest_presentation_time),a.writeUint32(this.first_offset),a.writeUint16(0),a.writeUint16(this.references.length);for(var b=0;b<this.references.length;b++){var c=this.references[b];a.writeUint32(c.reference_type<<31|c.referenced_size),a.writeUint32(c.subsegment_duration),a.writeUint32(c.starts_with_SAP<<31|c.SAP_type<<28|c.SAP_delta_time)}},BoxParser.stcoBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(a),a.writeUint32(this.chunk_offsets.length),a.writeUint32Array(this.chunk_offsets)},BoxParser.stscBox.prototype.write=function(a){var b;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(a),a.writeUint32(this.first_chunk.length),b=0;b<this.first_chunk.length;b++)a.writeUint32(this.first_chunk[b]),a.writeUint32(this.samples_per_chunk[b]),a.writeUint32(this.sample_description_index[b])},BoxParser.stsdBox.prototype.write=function(a){var b;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(a),a.writeUint32(this.entries.length),this.size+=4,b=0;b<this.entries.length;b++)this.entries[b].write(a),this.size+=this.entries[b].size;Log.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),a.adjustUint32(this.sizePosition,this.size)},BoxParser.stshBox.prototype.write=function(a){var b;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(a),a.writeUint32(this.shadowed_sample_numbers.length),b=0;b<this.shadowed_sample_numbers.length;b++)a.writeUint32(this.shadowed_sample_numbers[b]),a.writeUint32(this.sync_sample_numbers[b])},BoxParser.stssBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(a),a.writeUint32(this.sample_numbers.length),a.writeUint32Array(this.sample_numbers)},BoxParser.stszBox.prototype.write=function(a){var b,c=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(b=0;b+1<this.sample_sizes.length;){if(this.sample_sizes[b+1]!==this.sample_sizes[0]){c=!1;break}b++}else c=!1;this.size=8,c||(this.size+=4*this.sample_sizes.length),this.writeHeader(a),c?a.writeUint32(this.sample_sizes[0]):a.writeUint32(0),a.writeUint32(this.sample_sizes.length),c||a.writeUint32Array(this.sample_sizes)},BoxParser.sttsBox.prototype.write=function(a){var b;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(a),a.writeUint32(this.sample_counts.length),b=0;b<this.sample_counts.length;b++)a.writeUint32(this.sample_counts[b]),a.writeUint32(this.sample_deltas[b])},BoxParser.tfdtBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=4,1===this.version&&(this.size+=4),this.writeHeader(a),1===this.version?a.writeUint64(this.baseMediaDecodeTime):a.writeUint32(this.baseMediaDecodeTime)},BoxParser.tfhdBox.prototype.write=function(a){this.version=0,this.size=4,this.flags&BoxParser.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&BoxParser.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&BoxParser.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&BoxParser.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&BoxParser.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(a),a.writeUint32(this.track_id),this.flags&BoxParser.TFHD_FLAG_BASE_DATA_OFFSET&&a.writeUint64(this.base_data_offset),this.flags&BoxParser.TFHD_FLAG_SAMPLE_DESC&&a.writeUint32(this.default_sample_description_index),this.flags&BoxParser.TFHD_FLAG_SAMPLE_DUR&&a.writeUint32(this.default_sample_duration),this.flags&BoxParser.TFHD_FLAG_SAMPLE_SIZE&&a.writeUint32(this.default_sample_size),
this.flags&BoxParser.TFHD_FLAG_SAMPLE_FLAGS&&a.writeUint32(this.default_sample_flags)},BoxParser.tkhdBox.prototype.write=function(a){this.version=0,this.size=80,this.writeHeader(a),a.writeUint32(this.creation_time),a.writeUint32(this.modification_time),a.writeUint32(this.track_id),a.writeUint32(0),a.writeUint32(this.duration),a.writeUint32(0),a.writeUint32(0),a.writeInt16(this.layer),a.writeInt16(this.alternate_group),a.writeInt16(this.volume<<8),a.writeUint16(0),a.writeInt32Array(this.matrix),a.writeUint32(this.width),a.writeUint32(this.height)},BoxParser.trexBox.prototype.write=function(a){this.version=0,this.flags=0,this.size=20,this.writeHeader(a),a.writeUint32(this.track_id),a.writeUint32(this.default_sample_description_index),a.writeUint32(this.default_sample_duration),a.writeUint32(this.default_sample_size),a.writeUint32(this.default_sample_flags)},BoxParser.trunBox.prototype.write=function(a){this.version=0,this.size=4,this.flags&BoxParser.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&BoxParser.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&BoxParser.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&BoxParser.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&BoxParser.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&BoxParser.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(a),a.writeUint32(this.sample_count),this.flags&BoxParser.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=a.getPosition(),a.writeInt32(this.data_offset)),this.flags&BoxParser.TRUN_FLAGS_FIRST_FLAG&&a.writeUint32(this.first_sample_flags);for(var b=0;b<this.sample_count;b++)this.flags&BoxParser.TRUN_FLAGS_DURATION&&a.writeUint32(this.sample_duration[b]),this.flags&BoxParser.TRUN_FLAGS_SIZE&&a.writeUint32(this.sample_size[b]),this.flags&BoxParser.TRUN_FLAGS_FLAGS&&a.writeUint32(this.sample_flags[b]),this.flags&BoxParser.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?a.writeUint32(this.sample_composition_time_offset[b]):a.writeInt32(this.sample_composition_time_offset[b]))},BoxParser["url Box"].prototype.write=function(a){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(a),this.location&&a.writeCString(this.location)},BoxParser["urn Box"].prototype.write=function(a){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(a),a.writeCString(this.name),this.location&&a.writeCString(this.location)},BoxParser.vmhdBox.prototype.write=function(a){this.version=0,this.flags=1,this.size=8,this.writeHeader(a),a.writeUint16(this.graphicsmode),a.writeUint16Array(this.opcolor)},BoxParser.cttsBox.prototype.unpack=function(a){var b,c,d;for(d=0,b=0;b<this.sample_counts.length;b++)for(c=0;c<this.sample_counts[b];c++)a[d].pts=a[d].dts+this.sample_offsets[b],d++},BoxParser.sttsBox.prototype.unpack=function(a){var b,c,d;for(d=0,b=0;b<this.sample_counts.length;b++)for(c=0;c<this.sample_counts[b];c++)a[d].dts=0===d?0:a[d-1].dts+this.sample_deltas[b],d++},BoxParser.stcoBox.prototype.unpack=function(a){var b;for(b=0;b<this.chunk_offsets.length;b++)a[b].offset=this.chunk_offsets[b]},BoxParser.stscBox.prototype.unpack=function(a){var b,c,d,e,f;for(e=0,f=0,b=0;b<this.first_chunk.length;b++)for(c=0;c<(b+1<this.first_chunk.length?this.first_chunk[b+1]:1/0);c++)for(f++,d=0;d<this.samples_per_chunk[b];d++){if(!a[e])return;a[e].description_index=this.sample_description_index[b],a[e].chunk_index=f,e++}},BoxParser.stszBox.prototype.unpack=function(a){var b;for(b=0;b<this.sample_sizes.length;b++)a[b].size=this.sample_sizes[b]},BoxParser.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],BoxParser.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],BoxParser.boxEqualFields=function(a,b){if(a&&!b)return!1;var c;for(c in a)if(!(BoxParser.DIFF_BOXES_PROP_NAMES.indexOf(c)>-1||a[c]instanceof BoxParser.Box||b[c]instanceof BoxParser.Box||void 0===a[c]||void 0===b[c]||"function"==typeof a[c]||"function"==typeof b[c]||a.subBoxNames&&a.subBoxNames.indexOf(c.slice(0,4))>-1||b.subBoxNames&&b.subBoxNames.indexOf(c.slice(0,4))>-1||"data"===c||"start"===c||"size"===c||"creation_time"===c||"modification_time"===c||BoxParser.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(c)>-1||a[c]===b[c]))return!1;return!0},BoxParser.boxEqual=function(a,b){if(!BoxParser.boxEqualFields(a,b))return!1;for(var c=0;c<BoxParser.DIFF_BOXES_PROP_NAMES.length;c++){var d=BoxParser.DIFF_BOXES_PROP_NAMES[c];if(a[d]&&b[d]&&!BoxParser.boxEqual(a[d],b[d]))return!1}return!0};var VTTin4Parser=function(){};VTTin4Parser.prototype.parseSample=function(a){var b,c,d=new MP4BoxStream(a.buffer);for(b=[];!d.isEos();)c=BoxParser.parseOneBox(d,!1),c.code===BoxParser.OK&&"vttc"===c.box.type&&b.push(c.box);return b},VTTin4Parser.prototype.getText=function(a,b,c){function d(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a}function e(a){var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),e=Math.floor(a-3600*b-60*c),f=Math.floor(1e3*(a-3600*b-60*c-e));return d(b,2)+":"+d(c,2)+":"+d(e,2)+"."+d(f,3)}for(var f=this.parseSample(c),g="",h=0;h<f.length;h++){var i=f[h];g+=e(a)+" --\x3e "+e(b)+"\r\n",g+=i.payl.text}return g};var XMLSubtitlein4Parser=function(){};XMLSubtitlein4Parser.prototype.parseSample=function(a){var b,c={};c.resources=[];var d=new MP4BoxStream(a.data.buffer);if(a.subsamples&&0!==a.subsamples.length){if(c.documentString=d.readString(a.subsamples[0].size),a.subsamples.length>1)for(b=1;b<a.subsamples.length;b++)c.resources[b]=d.readUint8Array(a.subsamples[b].size)}else c.documentString=d.readString(a.data.length);return"undefined"!=typeof DOMParser&&(c.document=(new DOMParser).parseFromString(c.documentString,"application/xml")),c};var Textin4Parser=function(){};Textin4Parser.prototype.parseSample=function(a){return new MP4BoxStream(a.data.buffer).readString(a.data.length)},Textin4Parser.prototype.parseConfig=function(a){var b=new MP4BoxStream(a.buffer);return b.readUint32(),b.readCString()},"undefined"!=typeof exports&&(exports.XMLSubtitlein4Parser=XMLSubtitlein4Parser,exports.Textin4Parser=Textin4Parser);var ISOFile=function(a){this.stream=a||new MultiBufferStream,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1};ISOFile.prototype.setSegmentOptions=function(a,b,c){var d=this.getTrackById(a);if(d){var e={};this.fragmentedTracks.push(e),e.id=a,e.user=b,e.trak=d,d.nextSample=0,e.segmentStream=null,e.nb_samples=1e3,e.rapAlignement=!0,c&&(c.nbSamples&&(e.nb_samples=c.nbSamples),c.rapAlignement&&(e.rapAlignement=c.rapAlignement))}},ISOFile.prototype.unsetSegmentOptions=function(a){for(var b=-1,c=0;c<this.fragmentedTracks.length;c++){this.fragmentedTracks[c].id==a&&(b=c)}b>-1&&this.fragmentedTracks.splice(b,1)},ISOFile.prototype.setExtractionOptions=function(a,b,c){var d=this.getTrackById(a);if(d){var e={};this.extractedTracks.push(e),e.id=a,e.user=b,e.trak=d,d.nextSample=0,e.nb_samples=1e3,e.samples=[],c&&c.nbSamples&&(e.nb_samples=c.nbSamples)}},ISOFile.prototype.unsetExtractionOptions=function(a){for(var b=-1,c=0;c<this.extractedTracks.length;c++){this.extractedTracks[c].id==a&&(b=c)}b>-1&&this.extractedTracks.splice(b,1)},ISOFile.prototype.parse=function(){var a,b;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}if(this.saveParsePosition&&this.saveParsePosition(),a=BoxParser.parseOneBox(this.stream,!1),a.code===BoxParser.ERR_NOT_ENOUGH_DATA){if(this.processIncompleteBox){if(this.processIncompleteBox(a))continue;return}return}var c;switch(b=a.box,c="uuid"!==b.type?b.type:b.uuid,this.boxes.push(b),c){case"mdat":this.mdats.push(b);break;case"moof":this.moofs.push(b);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[c]&&Log.warn("ISOFile","Duplicate Box of type: "+c+", overriding previous occurrence"),this[c]=b}this.updateUsedBytes&&this.updateUsedBytes(b,a)}},ISOFile.prototype.checkBuffer=function(a){if(null===a||void 0===a)throw"Buffer must be defined and non empty";if(void 0===a.fileStart)throw"Buffer must have a fileStart property";return 0===a.byteLength?(Log.warn("ISOFile","Ignoring empty buffer (fileStart: "+a.fileStart+")"),this.stream.logBufferLevel(),!1):(Log.info("ISOFile","Processing buffer (fileStart: "+a.fileStart+")"),a.usedBytes=0,this.stream.insertBuffer(a),this.stream.logBufferLevel(),!!this.stream.initialized()||(Log.warn("ISOFile","Not ready to start parsing"),!1))},ISOFile.prototype.appendBuffer=function(a,b){var c;if(this.checkBuffer(a))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(b),this.nextSeekPosition?(c=this.nextSeekPosition,this.nextSeekPosition=void 0):c=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(c=this.stream.getEndFilePositionAfter(c))):c=this.nextParsePosition?this.nextParsePosition:0,this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(Log.info("ISOFile","Done processing buffer (fileStart: "+a.fileStart+") - next buffer to fetch should have a fileStart position of "+c),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),Log.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),c},ISOFile.prototype.getInfo=function(){var a,b,c,d,e,f={},g=new Date(4,0,1,0,0,0,0).getTime();if(this.moov)for(f.hasMoov=!0,f.duration=this.moov.mvhd.duration,f.timescale=this.moov.mvhd.timescale,f.isFragmented=null!=this.moov.mvex,f.isFragmented&&this.moov.mvex.mehd&&(f.fragment_duration=this.moov.mvex.mehd.fragment_duration),f.isProgressive=this.isProgressive,f.hasIOD=null!=this.moov.iods,f.brands=[],f.brands.push(this.ftyp.major_brand),f.brands=f.brands.concat(this.ftyp.compatible_brands),f.created=new Date(g+1e3*this.moov.mvhd.creation_time),f.modified=new Date(g+1e3*this.moov.mvhd.modification_time),f.tracks=[],f.audioTracks=[],f.videoTracks=[],f.subtitleTracks=[],f.metadataTracks=[],f.hintTracks=[],f.otherTracks=[],a=0;a<this.moov.traks.length;a++){if(c=this.moov.traks[a],e=c.mdia.minf.stbl.stsd.entries[0],d={},f.tracks.push(d),d.id=c.tkhd.track_id,d.name=c.mdia.hdlr.name,d.references=[],c.tref)for(b=0;b<c.tref.boxes.length;b++)ref={},d.references.push(ref),ref.type=c.tref.boxes[b].type,ref.track_ids=c.tref.boxes[b].track_ids;c.edts&&(d.edits=c.edts.elst.entries),d.created=new Date(g+1e3*c.tkhd.creation_time),d.modified=new Date(g+1e3*c.tkhd.modification_time),d.movie_duration=c.tkhd.duration,d.movie_timescale=f.timescale,d.layer=c.tkhd.layer,d.alternate_group=c.tkhd.alternate_group,d.volume=c.tkhd.volume,d.matrix=c.tkhd.matrix,d.track_width=c.tkhd.width/65536,d.track_height=c.tkhd.height/65536,d.timescale=c.mdia.mdhd.timescale,d.cts_shift=c.mdia.minf.stbl.cslg,d.duration=c.mdia.mdhd.duration,d.samples_duration=c.samples_duration,d.codec=e.getCodec(),d.kind=c.udta&&c.udta.kinds.length?c.udta.kinds[0]:{schemeURI:"",value:""},d.language=c.mdia.elng?c.mdia.elng.extended_language:c.mdia.mdhd.languageString,d.nb_samples=c.samples.length,d.size=c.samples_size,d.bitrate=8*d.size*d.timescale/d.samples_duration,e.isAudio()?(d.type="audio",f.audioTracks.push(d),d.audio={},d.audio.sample_rate=e.getSampleRate(),d.audio.channel_count=e.getChannelCount(),d.audio.sample_size=e.getSampleSize()):e.isVideo()?(d.type="video",f.videoTracks.push(d),d.video={},d.video.width=e.getWidth(),d.video.height=e.getHeight()):e.isSubtitle()?(d.type="subtitles",f.subtitleTracks.push(d)):e.isHint()?(d.type="metadata",f.hintTracks.push(d)):e.isMetadata()?(d.type="metadata",f.metadataTracks.push(d)):(d.type="metadata",f.otherTracks.push(d))}else f.hasMoov=!1;for(f.mime="",f.videoTracks.length>0?f.mime+='video/mp4; codecs="':f.audioTracks.length>0?f.mime+='audio/mp4; codecs="':f.mime+='application/mp4; codecs="',a=0;a<f.tracks.length;a++)0!==a&&(f.mime+=","),f.mime+=f.tracks[a].codec;return f.mime+='"; profiles="',f.mime+=this.ftyp.compatible_brands.join(),f.mime+='"',f},ISOFile.prototype.processSamples=function(a){var b,c;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(b=0;b<this.fragmentedTracks.length;b++){var d=this.fragmentedTracks[b];for(c=d.trak;c.nextSample<c.samples.length&&this.sampleProcessingStarted;){Log.debug("ISOFile","Creating media fragment on track #"+d.id+" for sample "+c.nextSample);var e=this.createFragment(d.id,c.nextSample,d.segmentStream);if(!e)break;if(d.segmentStream=e,(++c.nextSample%d.nb_samples==0||a&&c.nextSample>=c.samples.length)&&(Log.info("ISOFile","Sending fragmented data on track #"+d.id+" for samples ["+Math.max(0,c.nextSample-d.nb_samples)+","+(c.nextSample-1)+"]"),Log.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(d.id,d.user,d.segmentStream.buffer,c.nextSample,a&&c.nextSample>=c.samples.length),d.segmentStream=null,d!==this.fragmentedTracks[b]))break}}if(null!==this.onSamples)for(b=0;b<this.extractedTracks.length;b++){var f=this.extractedTracks[b];for(c=f.trak;c.nextSample<c.samples.length&&this.sampleProcessingStarted;){Log.debug("ISOFile","Exporting on track #"+f.id+" sample #"+c.nextSample);var g=this.getSample(c,c.nextSample);if(!g)break;if(c.nextSample++,f.samples.push(g),(c.nextSample%f.nb_samples==0||c.nextSample>=c.samples.length)&&(Log.debug("ISOFile","Sending samples on track #"+f.id+" for sample "+c.nextSample),this.onSamples&&this.onSamples(f.id,f.user,f.samples),f.samples=[],f!==this.extractedTracks[b]))break}}}},ISOFile.prototype.getBox=function(a){var b=this.getBoxes(a,!0);return b.length?b[0]:null},ISOFile.prototype.getBoxes=function(a,b){var c=[];return ISOFile._sweep.call(this,a,c,b),c},ISOFile._sweep=function(a,b,c){this.type&&this.type==a&&b.push(this);for(var d in this.boxes){if(b.length&&c)return;ISOFile._sweep.call(this.boxes[d],a,b,c)}},ISOFile.prototype.getTrackSamplesInfo=function(a){var b=this.getTrackById(a);return b?b.samples:void 0},ISOFile.prototype.getTrackSample=function(a,b){var c=this.getTrackById(a);return this.getSample(c,b)},ISOFile.prototype.releaseUsedSamples=function(a,b){var c=0,d=this.getTrackById(a);d.lastValidSample||(d.lastValidSample=0);for(var e=d.lastValidSample;e<b;e++)c+=this.releaseSample(d,e);Log.info("ISOFile","Track #"+a+" released samples up to "+b+" (released size: "+c+", remaining: "+this.samplesDataSize+")"),d.lastValidSample=b},ISOFile.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},ISOFile.prototype.stop=function(){this.sampleProcessingStarted=!1},ISOFile.prototype.flush=function(){Log.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},ISOFile.prototype.seekTrack=function(a,b,c){var d,e,f,g=1/0,h=0,i=0;if(0===c.samples.length)return Log.info("ISOFile","No sample in track, cannot seek! Using time "+Log.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(d=0;d<c.samples.length;d++){if(e=c.samples[d],0===d)i=0,f=e.timescale;else if(e.cts>a*e.timescale){i=d-1;break}b&&e.is_sync&&(h=d)}for(b&&(i=h),a=c.samples[i].cts,c.nextSample=i;c.samples[i].alreadyRead===c.samples[i].size;)i++;return g=c.samples[i].offset+c.samples[i].alreadyRead,Log.info("ISOFile","Seeking to "+(b?"RAP":"")+" sample #"+c.nextSample+" on track "+c.tkhd.track_id+", time "+Log.getDurationString(a,f)+" and offset: "+g),{offset:g,time:a/f}},ISOFile.prototype.seek=function(a,b){var c,d,e,f=this.moov,g={offset:1/0,time:1/0};if(this.moov){for(e=0;e<f.traks.length;e++)c=f.traks[e],d=this.seekTrack(a,b,c),d.offset<g.offset&&(g.offset=d.offset),d.time<g.time&&(g.time=d.time);return Log.info("ISOFile","Seeking at time "+Log.getDurationString(g.time,1)+" needs a buffer with a fileStart position of "+g.offset),g.offset===1/0?g={offset:this.nextParsePosition,time:0}:g.offset=this.stream.getEndFilePositionAfter(g.offset),Log.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+g.offset),g}throw"Cannot seek: moov not received!"},ISOFile.prototype.equal=function(a){for(var b=0;b<this.boxes.length&&b<a.boxes.length;){var c=this.boxes[b],d=a.boxes[b];if(!BoxParser.boxEqual(c,d))return!1;b++}return!0},"undefined"!=typeof exports&&(exports.ISOFile=ISOFile),ISOFile.prototype.lastBoxStartPosition=0,ISOFile.prototype.parsingMdat=null,ISOFile.prototype.nextParsePosition=0,ISOFile.prototype.discardMdatData=!1,ISOFile.prototype.processIncompleteBox=function(a){var b,c,d;return"mdat"===a.type?(b=new BoxParser[a.type+"Box"](a.size),this.parsingMdat=b,this.boxes.push(b),this.mdats.push(b),b.start=a.start,b.hdr_size=a.hdr_size,this.stream.addUsedBytes(b.hdr_size),this.lastBoxStartPosition=b.start+b.size,d=this.stream.seek(b.start+b.size,!1,this.discardMdatData),d?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=b.start+b.size,!1)):("moov"===a.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),c=!!this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer(),c?(this.nextParsePosition=this.stream.getEndPosition(),!0):(a.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+a.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},ISOFile.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat},ISOFile.prototype.processIncompleteMdat=function(){var a,b;return a=this.parsingMdat,b=this.stream.seek(a.start+a.size,!1,this.discardMdatData),b?(Log.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},ISOFile.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},ISOFile.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},ISOFile.prototype.updateUsedBytes=function(a,b){this.stream.addUsedBytes&&("mdat"===a.type?(this.stream.addUsedBytes(a.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(a.size-a.hdr_size)):this.stream.addUsedBytes(a.size))},ISOFile.prototype.add=BoxParser.Box.prototype.add,ISOFile.prototype.addBox=BoxParser.Box.prototype.addBox,ISOFile.prototype.init=function(a){var b=a||{},c=(this.add("ftyp").set("major_brand",b.brands&&b.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",b.brands||["iso4"]),this.add("moov"));return c.add("mvhd").set("timescale",b.timescale||600).set("rate",b.rate||1).set("creation_time",0).set("modification_time",0).set("duration",b.duration||0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("next_track_id",1),c.add("mvex"),this},ISOFile.prototype.addTrack=function(a){this.moov||this.init(a);var b=a||{};b.width=b.width||320,b.height=b.height||320,b.id=b.id||this.moov.mvhd.next_track_id,b.type=b.type||"avc1";var c=this.moov.add("trak");this.moov.mvhd.next_track_id=b.id+1,c.add("tkhd").set("flags",BoxParser.TKHD_FLAG_ENABLED|BoxParser.TKHD_FLAG_IN_MOVIE|BoxParser.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",b.id).set("duration",b.duration||0).set("layer",b.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",b.width).set("height",b.height);var d=c.add("mdia");d.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",b.timescale||1).set("duration",b.media_duration||0).set("language",b.language||0),d.add("hdlr").set("handler",b.hdlr||"vide").set("name",b.name||"Track created with MP4Box.js"),d.add("elng").set("extended_language",b.language||"fr-FR");var e=d.add("minf");if(void 0!==BoxParser[b.type+"SampleEntry"]){var f=new BoxParser[b.type+"SampleEntry"];f.data_reference_index=1;for(var g="",h=0;h<BoxParser.sampleEntryCodes.length;h++){var i=BoxParser.sampleEntryCodes[h];if(i.types.indexOf(b.type)>-1){g=i.prefix;break}}switch(g){case"Visual":e.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),f.set("width",b.width).set("height",b.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",b.type+" Compressor").set("depth",24);break;case"Audio":e.add("smhd").set("balance",b.balance||0),f.set("channel_count",b.channel_count||2).set("samplesize",b.samplesize||16).set("samplerate",b.samplerate||65536);break;case"Hint":e.add("hmhd");break;case"Subtitle":switch(e.add("sthd"),b.type){case"stpp":f.set("namespace",b.namespace||"nonamespace").set("schema_location",b.schema_location||"").set("auxiliary_mime_types",b.auxiliary_mime_types||"")}break;case"Metadata":case"System":default:e.add("nmhd")}b.description&&f.addBox(b.description),e.add("dinf").add("dref").addEntry((new BoxParser["url Box"]).set("flags",1));var j=e.add("stbl");return j.add("stsd").addEntry(f),j.add("stts").set("sample_counts",[]).set("sample_deltas",[]),j.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),j.add("stco").set("chunk_offsets",[]),j.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",b.id).set("default_sample_description_index",b.default_sample_description_index||1).set("default_sample_duration",b.default_sample_duration||0).set("default_sample_size",b.default_sample_size||0).set("default_sample_flags",b.default_sample_flags||0),this.buildTrakSampleLists(c),b.id}},BoxParser.Box.prototype.computeSize=function(a){var b=a||new DataStream;b.endianness=DataStream.BIG_ENDIAN,this.write(b)},ISOFile.prototype.addSample=function(a,b,c){var d=c||{},e={},f=this.getTrackById(a);if(null!==f){e.number=f.samples.length,e.track_id=f.tkhd.track_id,e.timescale=f.mdia.mdhd.timescale,e.description_index=d.sample_description_index?d.sample_description_index-1:0,e.description=f.mdia.minf.stbl.stsd.entries[e.description_index],e.data=b,e.size=b.length,e.alreadyRead=e.size,e.duration=d.duration||1,e.cts=d.cts||0,e.dts=d.dts||0,e.is_sync=d.is_sync||!1,e.is_leading=d.is_leading||0,e.depends_on=d.depends_on||0,e.is_depended_on=d.is_depended_on||0,e.has_redundancy=d.has_redundancy||0,e.degradation_priority=d.degradation_priority||0,e.offset=0,e.subsamples=d.subsamples,f.samples.push(e),f.samples_size+=e.size,f.samples_duration+=e.duration,this.processSamples();var g=ISOFile.createSingleSampleMoof(e);return this.addBox(g),g.computeSize(),g.trafs[0].truns[0].data_offset=g.size+8,this.add("mdat").data=b,e}},ISOFile.createSingleSampleMoof=function(a){var b=new BoxParser.moofBox;b.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var c=b.add("traf");return c.add("tfhd").set("track_id",a.track_id).set("flags",BoxParser.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),c.add("tfdt").set("baseMediaDecodeTime",a.dts),c.add("trun").set("flags",BoxParser.TRUN_FLAGS_DATA_OFFSET|BoxParser.TRUN_FLAGS_DURATION|BoxParser.TRUN_FLAGS_SIZE|BoxParser.TRUN_FLAGS_FLAGS|BoxParser.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[a.duration]).set("sample_size",[a.size]).set("sample_flags",[0]).set("sample_composition_time_offset",[a.cts-a.dts]),b},ISOFile.prototype.lastMoofIndex=0,ISOFile.prototype.samplesDataSize=0,ISOFile.prototype.resetTables=function(){var a,b,c,d,e,f,g,h;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,a=0;a<this.moov.traks.length;a++){b=this.moov.traks[a],b.tkhd.duration=0,b.mdia.mdhd.duration=0,c=b.mdia.minf.stbl.stco||b.mdia.minf.stbl.co64,c.chunk_offsets=[],d=b.mdia.minf.stbl.stsc,d.first_chunk=[],d.samples_per_chunk=[],d.sample_description_index=[],e=b.mdia.minf.stbl.stsz||b.mdia.minf.stbl.stz2,e.sample_sizes=[],f=b.mdia.minf.stbl.stts,f.sample_counts=[],f.sample_deltas=[],g=b.mdia.minf.stbl.ctts,g&&(g.sample_counts=[],g.sample_offsets=[]),h=b.mdia.minf.stbl.stss;var i=b.mdia.minf.stbl.boxes.indexOf(h);-1!=i&&(b.mdia.minf.stbl.boxes[i]=null)}},ISOFile.initSampleGroups=function(a,b,c,d,e){function f(a,b,c){this.grouping_type=a,this.grouping_type_parameter=b,this.sbgp=c,this.last_sample_in_run=-1,this.entry_index=-1}var g,h,i,j;for(b&&(b.sample_groups_info=[]),a.sample_groups_info||(a.sample_groups_info=[]),h=0;h<c.length;h++){for(j=c[h].grouping_type+"/"+c[h].grouping_type_parameter,i=new f(c[h].grouping_type,c[h].grouping_type_parameter,c[h]),b&&(b.sample_groups_info[j]=i),a.sample_groups_info[j]||(a.sample_groups_info[j]=i),g=0;g<d.length;g++)d[g].grouping_type===c[h].grouping_type&&(i.description=d[g],i.description.used=!0);if(e)for(g=0;g<e.length;g++)e[g].grouping_type===c[h].grouping_type&&(i.fragment_description=e[g],i.fragment_description.used=!0,i.is_fragment=!0)}if(b){if(e)for(h=0;h<e.length;h++)!e[h].used&&e[h].version>=2&&(j=e[h].grouping_type+"/0",i=new f(e[h].grouping_type,0),i.is_fragment=!0,b.sample_groups_info[j]||(b.sample_groups_info[j]=i))}else for(h=0;h<d.length;h++)!d[h].used&&d[h].version>=2&&(j=d[h].grouping_type+"/0",i=new f(d[h].grouping_type,0),a.sample_groups_info[j]||(a.sample_groups_info[j]=i))},ISOFile.setSampleGroupProperties=function(a,b,c,d){var e,f;b.sample_groups=[];for(e in d)if(b.sample_groups[e]={},b.sample_groups[e].grouping_type=d[e].grouping_type,b.sample_groups[e].grouping_type_parameter=d[e].grouping_type_parameter,c>=d[e].last_sample_in_run&&(d[e].last_sample_in_run<0&&(d[e].last_sample_in_run=0),++d[e].entry_index<=d[e].sbgp.entries.length-1&&(d[e].last_sample_in_run+=d[e].sbgp.entries[d[e].entry_index].sample_count)),d[e].entry_index<=d[e].sbgp.entries.length-1?b.sample_groups[e].group_description_index=d[e].sbgp.entries[d[e].entry_index].group_description_index:b.sample_groups[e].group_description_index=-1,0!==b.sample_groups[e].group_description_index){var g;g=d[e].fragment_description?d[e].fragment_description:d[e].description,b.sample_groups[e].group_description_index>0?(f=b.sample_groups[e].group_description_index>65535?(b.sample_groups[e].group_description_index>>16)-1:b.sample_groups[e].group_description_index-1,g&&f>=0&&(b.sample_groups[e].description=g.entries[f])):g&&g.version>=2&&g.default_group_description_index>0&&(b.sample_groups[e].description=g.entries[g.default_group_description_index-1])}},ISOFile.process_sdtp=function(a,b,c){b&&(a?(b.is_leading=a.is_leading[c],b.depends_on=a.sample_depends_on[c],b.is_depended_on=a.sample_is_depended_on[c],b.has_redundancy=a.sample_has_redundancy[c]):(b.is_leading=0,b.depends_on=0,b.is_depended_on=0,b.has_redundancy=0))},ISOFile.prototype.buildSampleLists=function(){var a;for(a=0;a<this.moov.traks.length;a++)trak=this.moov.traks[a],this.buildTrakSampleLists(trak)},ISOFile.prototype.buildTrakSampleLists=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;if(a.samples=[],a.samples_duration=0,a.samples_size=0,c=a.mdia.minf.stbl.stco||a.mdia.minf.stbl.co64,d=a.mdia.minf.stbl.stsc,e=a.mdia.minf.stbl.stsz||a.mdia.minf.stbl.stz2,f=a.mdia.minf.stbl.stts,g=a.mdia.minf.stbl.ctts,h=a.mdia.minf.stbl.stss,i=a.mdia.minf.stbl.stsd,j=a.mdia.minf.stbl.subs,m=a.mdia.minf.stbl.stdp,k=a.mdia.minf.stbl.sbgps,l=a.mdia.minf.stbl.sgpds,s=-1,t=-1,u=-1,v=-1,w=0,x=0,y=0,ISOFile.initSampleGroups(a,null,k,l),void 0!==e){for(b=0;b<e.sample_sizes.length;b++){var z={};z.number=b,z.track_id=a.tkhd.track_id,z.timescale=a.mdia.mdhd.timescale,z.alreadyRead=0,a.samples[b]=z,z.size=e.sample_sizes[b],a.samples_size+=z.size,0===b?(o=1,n=0,z.chunk_index=o,z.chunk_run_index=n,r=d.samples_per_chunk[n],q=0,p=n+1<d.first_chunk.length?d.first_chunk[n+1]-1:1/0):b<r?(z.chunk_index=o,z.chunk_run_index=n):(o++,z.chunk_index=o,q=0,o<=p||(n++,p=n+1<d.first_chunk.length?d.first_chunk[n+1]-1:1/0),z.chunk_run_index=n,r+=d.samples_per_chunk[n]),z.description_index=d.sample_description_index[z.chunk_run_index]-1,z.description=i.entries[z.description_index],z.offset=c.chunk_offsets[z.chunk_index-1]+q,q+=z.size,b>s&&(t++,s<0&&(s=0),s+=f.sample_counts[t]),b>0?(a.samples[b-1].duration=f.sample_deltas[t],a.samples_duration+=a.samples[b-1].duration,z.dts=a.samples[b-1].dts+a.samples[b-1].duration):z.dts=0,g?(b>=u&&(v++,u<0&&(u=0),u+=g.sample_counts[v]),z.cts=a.samples[b].dts+g.sample_offsets[v]):z.cts=z.dts,h?(b==h.sample_numbers[w]-1?(z.is_sync=!0,w++):(z.is_sync=!1,z.degradation_priority=0),j&&j.entries[x].sample_delta+y==b+1&&(z.subsamples=j.entries[x].subsamples,y+=j.entries[x].sample_delta,x++)):z.is_sync=!0,ISOFile.process_sdtp(a.mdia.minf.stbl.sdtp,z,z.number),z.degradation_priority=m?m.priority[b]:0,j&&j.entries[x].sample_delta+y==b&&(z.subsamples=j.entries[x].subsamples,y+=j.entries[x].sample_delta),(k.length>0||l.length>0)&&ISOFile.setSampleGroupProperties(a,z,b,a.sample_groups_info)}b>0&&(a.samples[b-1].duration=Math.max(a.mdia.mdhd.duration-a.samples[b-1].dts,0),a.samples_duration+=a.samples[b-1].duration)}},ISOFile.prototype.updateSampleLists=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;if(void 0!==this.moov)for(;this.lastMoofIndex<this.moofs.length;)if(i=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==i.type)for(j=i,a=0;a<j.trafs.length;a++){for(k=j.trafs[a],l=this.getTrackById(k.tfhd.track_id),m=this.getTrexById(k.tfhd.track_id),d=k.tfhd.flags&BoxParser.TFHD_FLAG_SAMPLE_DESC?k.tfhd.default_sample_description_index:m?m.default_sample_description_index:1,e=k.tfhd.flags&BoxParser.TFHD_FLAG_SAMPLE_DUR?k.tfhd.default_sample_duration:m?m.default_sample_duration:0,f=k.tfhd.flags&BoxParser.TFHD_FLAG_SAMPLE_SIZE?k.tfhd.default_sample_size:m?m.default_sample_size:0,g=k.tfhd.flags&BoxParser.TFHD_FLAG_SAMPLE_FLAGS?k.tfhd.default_sample_flags:m?m.default_sample_flags:0,k.sample_number=0,k.sbgps.length>0&&ISOFile.initSampleGroups(l,k,k.sbgps,l.mdia.minf.stbl.sgpds,k.sgpds),b=0;b<k.truns.length;b++){var p=k.truns[b];for(c=0;c<p.sample_count;c++){n={},n.number_in_traf=k.sample_number,k.sample_number++,n.number=l.samples.length,k.first_sample_index=l.samples.length,l.samples.push(n),n.track_id=l.tkhd.track_id,n.timescale=l.mdia.mdhd.timescale,n.description_index=d-1,n.description=l.mdia.minf.stbl.stsd.entries[n.description_index],n.size=f,p.flags&BoxParser.TRUN_FLAGS_SIZE&&(n.size=p.sample_size[c]),l.samples_size+=n.size,n.duration=e,p.flags&BoxParser.TRUN_FLAGS_DURATION&&(n.duration=p.sample_duration[c]),l.samples_duration+=n.duration,l.first_traf_merged||c>0?n.dts=l.samples[l.samples.length-2].dts+l.samples[l.samples.length-2].duration:(k.tfdt?n.dts=k.tfdt.baseMediaDecodeTime:n.dts=0,l.first_traf_merged=!0),n.cts=n.dts,p.flags&BoxParser.TRUN_FLAGS_CTS_OFFSET&&(n.cts=n.dts+p.sample_composition_time_offset[c]),o=g,p.flags&BoxParser.TRUN_FLAGS_FLAGS?o=p.sample_flags[c]:0===c&&p.flags&BoxParser.TRUN_FLAGS_FIRST_FLAG&&(o=p.first_sample_flags),n.is_sync=!(o>>16&1),n.is_leading=o>>26&3,n.depends_on=o>>24&3,n.is_depended_on=o>>22&3,n.has_redundancy=o>>20&3,n.degradation_priority=65535&o;var q=!!(k.tfhd.flags&BoxParser.TFHD_FLAG_BASE_DATA_OFFSET),r=!!(k.tfhd.flags&BoxParser.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),s=!!(p.flags&BoxParser.TRUN_FLAGS_DATA_OFFSET),t=0
;t=q?k.tfhd.base_data_offset:r?j.start:0===b?j.start:h,n.offset=0===b&&0===c?s?t+p.data_offset:t:h,h=n.offset+n.size,(k.sbgps.length>0||k.sgpds.length>0||l.mdia.minf.stbl.sbgps.length>0||l.mdia.minf.stbl.sgpds.length>0)&&ISOFile.setSampleGroupProperties(l,n,n.number_in_traf,k.sample_groups_info)}}if(k.subs){l.has_fragment_subsamples=!0;var u=k.first_sample_index;for(b=0;b<k.subs.entries.length;b++)u+=k.subs.entries[b].sample_delta,n=l.samples[u-1],n.subsamples=k.subs.entries[b].subsamples}}},ISOFile.prototype.getSample=function(a,b){var c,d=a.samples[b];if(!this.moov)return null;if(d.data){if(d.alreadyRead==d.size)return d}else d.data=new Uint8Array(d.size),d.alreadyRead=0,this.samplesDataSize+=d.size,Log.debug("ISOFile","Allocating sample #"+b+" on track #"+a.tkhd.track_id+" of size "+d.size+" (total: "+this.samplesDataSize+")");var e=this.stream.findPosition(!0,d.offset+d.alreadyRead,!1);if(e>-1){c=this.stream.buffers[e];var f=c.byteLength-(d.offset+d.alreadyRead-c.fileStart);return d.size-d.alreadyRead<=f?(Log.debug("ISOFile","Getting sample #"+b+" data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-c.fileStart)+" read size: "+(d.size-d.alreadyRead)+" full size: "+d.size+")"),DataStream.memcpy(d.data.buffer,d.alreadyRead,c,d.offset+d.alreadyRead-c.fileStart,d.size-d.alreadyRead),c.usedBytes+=d.size-d.alreadyRead,this.stream.logBufferLevel(),d.alreadyRead=d.size,d):(Log.debug("ISOFile","Getting sample #"+b+" partial data (alreadyRead: "+d.alreadyRead+" offset: "+(d.offset+d.alreadyRead-c.fileStart)+" read size: "+f+" full size: "+d.size+")"),DataStream.memcpy(d.data.buffer,d.alreadyRead,c,d.offset+d.alreadyRead-c.fileStart,f),d.alreadyRead+=f,c.usedBytes+=f,this.stream.logBufferLevel(),null)}return null},ISOFile.prototype.releaseSample=function(a,b){var c=a.samples[b];return c.data?(this.samplesDataSize-=c.size,c.data=null,c.alreadyRead=0,c.size):0},ISOFile.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},ISOFile.prototype.getCodecs=function(){var a,b="";for(a=0;a<this.moov.traks.length;a++){var c=this.moov.traks[a];a>0&&(b+=","),b+=c.mdia.minf.stbl.stsd.entries[0].getCodec()}return b},ISOFile.prototype.getTrexById=function(a){var b;if(!this.moov||!this.moov.mvex)return null;for(b=0;b<this.moov.mvex.trexs.length;b++){var c=this.moov.mvex.trexs[b];if(c.track_id==a)return c}return null},ISOFile.prototype.getTrackById=function(a){if(void 0===this.moov)return null;for(var b=0;b<this.moov.traks.length;b++){var c=this.moov.traks[b];if(c.tkhd.track_id==a)return c}return null},ISOFile.prototype.items=[],ISOFile.prototype.itemsDataSize=0,ISOFile.prototype.flattenItemInfo=function(){var a,b,c,d=this.items,e=this.meta;if(null!==e&&void 0!==e&&void 0!==e.hdlr&&void 0!==e.iinf){for(a=0;a<e.iinf.item_infos.length;a++)c={},c.id=e.iinf.item_infos[a].item_ID,d[c.id]=c,c.ref_to=[],c.name=e.iinf.item_infos[a].item_name,e.iinf.item_infos[a].protection_index>0&&(c.protection=e.ipro.protections[e.iinf.item_infos[a].protection_index-1]),e.iinf.item_infos[a].item_type?c.type=e.iinf.item_infos[a].item_type:c.type="mime",c.content_type=e.iinf.item_infos[a].content_type,c.content_encoding=e.iinf.item_infos[a].content_encoding;if(e.iloc)for(a=0;a<e.iloc.items.length;a++){var f=e.iloc.items[a];if(c=d[f.item_ID],0!==f.data_reference_index&&(Log.warn("Item storage with reference to other files: not supported"),c.source=e.dinf.boxes[f.data_reference_index-1]),void 0!==f.construction_method)Log.warn("Item storage with construction_method : not supported"),f.construction_method;else for(c.extents=[],c.size=0,b=0;b<f.extents.length;b++)c.extents[b]={},c.extents[b].offset=f.extents[b].extent_offset+f.base_offset,c.extents[b].length=f.extents[b].extent_length,c.extents[b].alreadyRead=0,c.size+=c.extents[b].length}if(e.pitm&&(d[e.pitm.item_id].primary=!0),e.iref)for(a=0;a<e.iref.references.length;a++){var g=e.iref.references[a];for(b=0;b<g.references.length;b++)d[g.from_item_ID].ref_to.push({type:g.type,id:g.references[b]})}}},ISOFile.prototype.getItem=function(a){var b,c;if(!this.meta)return null;if(c=this.items[a],!c.data&&c.size)c.data=new Uint8Array(c.size),c.alreadyRead=0,this.itemsDataSize+=c.size,Log.debug("ISOFile","Allocating item #"+a+" of size "+c.size+" (total: "+this.itemsDataSize+")");else if(c.alreadyRead===c.size)return c;for(var d=0;d<c.extents.length;d++){var e=c.extents[d];if(e.alreadyRead!==e.length){var f=this.stream.findPosition(!0,e.offset+e.alreadyRead,!1);if(!(f>-1))return null;b=this.stream.buffers[f];var g=b.byteLength-(e.offset+e.alreadyRead-b.fileStart);if(!(e.length-e.alreadyRead<=g))return Log.debug("ISOFile","Getting item #"+a+" extent #"+d+" partial data (alreadyRead: "+e.alreadyRead+" offset: "+(e.offset+e.alreadyRead-b.fileStart)+" read size: "+g+" full extent size: "+e.length+" full item size: "+c.size+")"),DataStream.memcpy(c.data.buffer,c.alreadyRead,b,e.offset+e.alreadyRead-b.fileStart,g),e.alreadyRead+=g,c.alreadyRead+=g,b.usedBytes+=g,this.stream.logBufferLevel(),null;Log.debug("ISOFile","Getting item #"+a+" extent #"+d+" data (alreadyRead: "+e.alreadyRead+" offset: "+(e.offset+e.alreadyRead-b.fileStart)+" read size: "+(e.length-e.alreadyRead)+" full extent size: "+e.length+" full item size: "+c.size+")"),DataStream.memcpy(c.data.buffer,c.alreadyRead,b,e.offset+e.alreadyRead-b.fileStart,e.length-e.alreadyRead),b.usedBytes+=e.length-e.alreadyRead,this.stream.logBufferLevel(),e.alreadyRead=e.length,c.alreadyRead+=e.length}}return c.alreadyRead===c.size?c:null},ISOFile.prototype.releaseItem=function(a){var b=this.items[a];if(b.data){this.itemsDataSize-=b.size,b.data=null,b.alreadyRead=0;for(var c=0;c<b.extents.length;c++){b.extents[c].alreadyRead=0}return b.size}return 0},ISOFile.prototype.processItems=function(a){for(var b in this.items){var c=this.items[b];this.getItem(c.id),a&&!c.sent&&(a(c),c.sent=!0,c.data=null)}},ISOFile.prototype.hasItem=function(a){for(var b in this.items){var c=this.items[b];if(c.name===a)return c.id}return-1},ISOFile.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},ISOFile.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?this.getItem(this.meta.pitm.item_id):null},ISOFile.prototype.write=function(a){for(var b=0;b<this.boxes.length;b++)this.boxes[b].write(a)},ISOFile.prototype.createFragment=function(a,b,c){var d=this.getTrackById(a),e=this.getSample(d,b);if(null==e)return e=d.samples[b],this.nextSeekPosition?this.nextSeekPosition=Math.min(e.offset+e.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=d.samples[b].offset+e.alreadyRead,null;var f=c||new DataStream;f.endianness=DataStream.BIG_ENDIAN;var g=ISOFile.createSingleSampleMoof(e);g.write(f),g.trafs[0].truns[0].data_offset=g.size+8,Log.debug("MP4Box","Adjusting data_offset with new value "+g.trafs[0].truns[0].data_offset),f.adjustUint32(g.trafs[0].truns[0].data_offset_position,g.trafs[0].truns[0].data_offset);var h=new BoxParser.mdatBox;return h.data=e.data,h.write(f),f},ISOFile.writeInitializationSegment=function(a,b,c,d){var e;Log.debug("ISOFile","Generating initialization segment");var f=new DataStream;f.endianness=DataStream.BIG_ENDIAN,a.write(f);var g=b.add("mvex");for(c&&g.add("mehd").set("fragment_duration",c),e=0;e<b.traks.length;e++)g.add("trex").set("track_id",b.traks[e].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",d).set("default_sample_size",0).set("default_sample_flags",65536);return b.write(f),f.buffer},ISOFile.prototype.save=function(a){var b=new DataStream;b.endianness=DataStream.BIG_ENDIAN,this.write(b),b.save(a)},ISOFile.prototype.getBuffer=function(){var a=new DataStream;return a.endianness=DataStream.BIG_ENDIAN,this.write(a),a.buffer},ISOFile.prototype.initializeSegmentation=function(){var a,b,c,d;for(null===this.onSegment&&Log.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),b=[],a=0;a<this.fragmentedTracks.length;a++){var e=new BoxParser.moovBox;e.mvhd=this.moov.mvhd,e.boxes.push(e.mvhd),c=this.getTrackById(this.fragmentedTracks[a].id),e.boxes.push(c),e.traks.push(c),d={},d.id=c.tkhd.track_id,d.user=this.fragmentedTracks[a].user,d.buffer=ISOFile.writeInitializationSegment(this.ftyp,e,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[a].samples.length>0?this.moov.traks[a].samples[0].duration:0),b.push(d)}return b},BoxParser.Box.prototype.printHeader=function(a){this.size+=8,this.size>MAX_SIZE&&(this.size+=8),"uuid"===this.type&&(this.size+=16),a.log(a.indent+"size:"+this.size),a.log(a.indent+"type:"+this.type)},BoxParser.FullBox.prototype.printHeader=function(a){this.size+=4,BoxParser.Box.prototype.printHeader.call(this,a),a.log(a.indent+"version:"+this.version),a.log(a.indent+"flags:"+this.flags)},BoxParser.Box.prototype.print=function(a){this.printHeader(a)},BoxParser.ContainerBox.prototype.print=function(a){this.printHeader(a);for(var b=0;b<this.boxes.length;b++)if(this.boxes[b]){var c=a.indent;a.indent+=" ",this.boxes[b].print(a),a.indent=c}},ISOFile.prototype.print=function(a){a.indent="";for(var b=0;b<this.boxes.length;b++)this.boxes[b]&&this.boxes[b].print(a)},BoxParser.mvhdBox.prototype.print=function(a){BoxParser.FullBox.prototype.printHeader.call(this,a),a.log(a.indent+"creation_time: "+this.creation_time),a.log(a.indent+"modification_time: "+this.modification_time),a.log(a.indent+"timescale: "+this.timescale),a.log(a.indent+"duration: "+this.duration),a.log(a.indent+"rate: "+this.rate),a.log(a.indent+"volume: "+(this.volume>>8)),a.log(a.indent+"matrix: "+this.matrix.join(", ")),a.log(a.indent+"next_track_id: "+this.next_track_id)},BoxParser.tkhdBox.prototype.print=function(a){BoxParser.FullBox.prototype.printHeader.call(this,a),a.log(a.indent+"creation_time: "+this.creation_time),a.log(a.indent+"modification_time: "+this.modification_time),a.log(a.indent+"track_id: "+this.track_id),a.log(a.indent+"duration: "+this.duration),a.log(a.indent+"volume: "+(this.volume>>8)),a.log(a.indent+"matrix: "+this.matrix.join(", ")),a.log(a.indent+"layer: "+this.layer),a.log(a.indent+"alternate_group: "+this.alternate_group),a.log(a.indent+"width: "+this.width),a.log(a.indent+"height: "+this.height)};var MP4Box={};MP4Box.createFile=function(a,b){var c=void 0===a||a,d=new ISOFile(b);return d.discardMdatData=!c,d},"undefined"!=typeof exports&&(exports.createFile=MP4Box.createFile);
